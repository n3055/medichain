{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medichain - Rental DApp</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.5/web3.min.js"></script>
    <script src='https://cdn.jotfor.ms/s/umd/latest/for-embedded-agent.js'></script>
    <link rel="stylesheet" href="{% static 'index.css' %}">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-link" style="color: var(--primary);"></i>
                    <span>Medichain</span>
                </div>
                <button class="sidebar-toggle" id="sidebar-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="sidebar-content">
                <ul class="sidebar-menu">
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link active" data-page="dashboard">
                            <i class="fas fa-th-large"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link" data-page="products">
                            <i class="fas fa-box"></i>
                            <span>Products</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link" data-page="add-product">
                            <i class="fas fa-plus-circle"></i>
                            <span>Add Product</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link" data-page="orders">
                            <i class="fas fa-clipboard-list"></i>
                            <span>Orders</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link" data-page="map-view">
                            <i class="fas fa-map-marked-alt"></i>
                            <span>Map View</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link" data-page="settings">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                </ul>
            </div>
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-details">
                        <div class="user-name" id="user-address">Not Connected</div>
                        <div class="user-role">Wallet not connected</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <button class="sidebar-toggle" id="sidebar-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title" id="page-title">Dashboard</h1>
                <div class="header-actions">
                    <div class="balance-display">
                        <i class="fab fa-ethereum"></i>
                        <span id="eth-balance">0</span> ETH
                    </div>
                    <button class="btn btn-primary" id="connect-wallet">
                        <i class="fas fa-wallet"></i>
                        Connect Wallet
                    </button>
                </div>
            </header>

            <div class="content">
                <!-- Dashboard Page -->
                <div class="page" id="dashboard-page">
                    <div class="dashboard">
                        <div class="dashboard-header">
                            <h2 class="dashboard-title">Dashboard Overview</h2>
                            <div class="dashboard-actions">
                                <button class="btn btn-primary" id="rent-now-btn">
                                    <i class="fas fa-shopping-cart"></i>
                                    Rent Now
                                </button>
                                <button class="btn btn-outline" id="add-product-btn">
                                    <i class="fas fa-plus"></i>
                                    Add Product
                                </button>
                            </div>
                        </div>

                        <script>
                          window.addEventListener("DOMContentLoaded", function() {
                            window.AgentInitializer.init({
                              agentRenderURL: "https://agent.jotform.com/0195acef6ba2785686ac249d516aa5d4b50e",
                              rootId: "JotformAgent-0195acef6ba2785686ac249d516aa5d4b50e",
                              formID: "0195acef6ba2785686ac249d516aa5d4b50e",
                              queryParams: ["skipWelcome=1", "maximizable=1"],
                              domain: "https://www.jotform.com",
                              isDraggable: false,
                              background: "linear-gradient(180deg, #D3CBF4 0%, #D3CBF4 100%)",
                              buttonBackgroundColor: "#8797FF",
                              buttonIconColor: "#FFFFFF",
                              variant: false,
                              customizations: {
                                "greeting": "Yes",
                                "greetingMessage": "Hi! How can I assist you?",
                                "openByDefault": "No",
                                "pulse": "Yes",
                                "position": "right",
                                "autoOpenChatIn": "0"
                              },
                              isVoice: undefined
                            });
                          });
                        </script>

                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-title">Total Products</div>
                                    <div class="stat-icon blue">
                                        <i class="fas fa-box"></i>
                                    </div>
                                </div>
                                <div class="stat-value">24</div>
                                <div class="stat-change positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>12% from last month</span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-title">Active Rentals</div>
                                    <div class="stat-icon green">
                                        <i class="fas fa-handshake"></i>
                                    </div>
                                </div>
                                <div class="stat-value">8</div>
                                <div class="stat-change positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>5% from last month</span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-title">Pending Orders</div>
                                    <div class="stat-icon orange">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                </div>
                                <div class="stat-value">3</div>
                                <div class="stat-change negative">
                                    <i class="fas fa-arrow-down"></i>
                                    <span>2% from last month</span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-title">Total Revenue</div>
                                    <div class="stat-icon blue">
                                        <i class="fab fa-ethereum"></i>
                                    </div>
                                </div>
                                <div class="stat-value">5.24 ETH</div>
                                <div class="stat-change positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>18% from last month</span>
                                </div>
                            </div>
                        </div>

                        <div class="section-header">
                            <h3 class="section-title">Featured Products</h3>
                            <div class="filter-options">
                                <div class="filter-option active">All</div>
                                <div class="filter-option">Available</div>
                                <div class="filter-option">Medical</div>
                                <div class="filter-option">Equipment</div>
                            </div>
                        </div>

                        <div class="product-grid" id="product-container">
                            <!-- Products will be loaded here dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Products Page -->
                <div class="page hidden" id="products-page">
                    <div class="section-header">
                        <h2 class="dashboard-title">All Products</h2>
                        <div class="filter-options">
                            <div class="filter-option active">All</div>
                            <div class="filter-option">Available</div>
                            <div class="filter-option">Unavailable</div>
                        </div>
                    </div>
                    <div class="product-grid" id="all-products-container">
                        <!-- All products will be loaded here -->
                    </div>
                </div>

                <!-- Add Product Page -->
                <div class="page hidden" id="add-product-page">
                    <div class="dashboard-header">
                        <h2 class="dashboard-title">Add New Product</h2>
                    </div>
                    <div class="form-container">
                        <form id="add-product-form">
                            <div class="form-group">
                                <label class="form-label" for="product-name">Product Name</label>
                                <input type="text" class="form-control" id="product-name" placeholder="Enter product name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="product-price">Price (ETH)</label>
                                <input type="number" class="form-control" id="product-price" placeholder="0.01" step="0.001" min="0" required>
                                <div class="form-text">Price per hour in ETH</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="product-description">Description</label>
                                <textarea class="form-control" id="product-description" rows="4" placeholder="Enter product description"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Location</label>
                                <div class="location-inputs">
                                    <div class="location-coordinates">
                                        <input type="text" class="form-control" id="product-latitude" placeholder="Latitude" readonly>
                                        <input type="text" class="form-control" id="product-longitude" placeholder="Longitude" readonly>
                                    </div>
                                    <button type="button" class="btn btn-outline" id="get-location-btn">
                                        <i class="fas fa-map-marker-alt"></i>
                                        Get Current Location
                                    </button>
                                </div>
                                <div class="form-text">Click the button to automatically fetch your current location</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="rental-radius">Rental Radius (km)</label>
                                <div class="radius-selector">
                                    <input type="range" class="form-control" id="rental-radius" min="1" max="50" value="5" step="1">
                                    <div class="radius-value-display">
                                        <span id="radius-value">5</span> km
                                    </div>
                                </div>
                                <div class="form-text">Select the radius within which you want to rent your product</div>
                            </div>
                            <div class="form-group">
                                <div class="toggle-container">
                                    <label class="toggle-label">
                                        Allow Sub-renting
                                        <div class="info-icon">
                                            <i class="fas fa-info-circle"></i>
                                            <div class="info-tooltip">
                                                Sub-renting allows the renter to rent this product to other users while they have it rented, creating a rental chain. You'll still earn your original rental fee.
                                            </div>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="allow-subrenting">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <div id="location-map" style="height: 300px; border-radius: 12px;"></div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus-circle"></i>
                                Add Product
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Orders Page -->
                <div class="page hidden" id="orders-page">
                    <div class="dashboard-header">
                        <h2 class="dashboard-title">Order Status</h2>
                        <div class="filter-options">
                            <div class="filter-option active" data-filter="all">All</div>
                            <div class="filter-option" data-filter="owned">My Products</div>
                            <div class="filter-option" data-filter="rented">Rented by Me</div>
                            <div class="filter-option" data-filter="active">Active Rentals</div>
                            <div class="filter-option" data-filter="available">Available</div>
                        </div>
                    </div>
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Product</th>
                                <th>Date</th>
                                <th>Price</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body">
                            <!-- Orders will be dynamically added here -->
                        </tbody>
                    </table>
                </div>

                <!-- Settings Page -->
                <div class="page hidden" id="settings-page">
                    <div class="dashboard-header">
                        <h2 class="dashboard-title">Settings</h2>
                    </div>
                    <div class="form-container">
                        <form id="settings-form">
                            <div class="form-group">
                                <label class="form-label" for="user-name">Display Name</label>
                                <input type="text" class="form-control" id="user-name" placeholder="Enter your name">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="user-email">Email</label>
                                <input type="email" class="form-control" id="user-email" placeholder="Enter your email">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Connected Wallet</label>
                                <div class="form-control" id="connected-wallet-display">Not connected</div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i>
                                Save Settings
                            </button>
                        </form>
                    </div>
                </div>
                <!-- Map View Page -->
                <div class="page hidden" id="map-view-page">
                    <div class="dashboard-header">
                        <h2 class="dashboard-title">Product Map</h2>
                        <div class="filter-options">
                            <div class="filter-option active">All Products</div>
                            <div class="filter-option">Available Only</div>
                            <div class="filter-option">My Products</div>
                        </div>
                    </div>
                    <div class="map-container" style="position: relative;">
                        <div id="products-map" style="height: 600px; border-radius: 12px;"></div>
                        <button class="btn btn-primary map-location-btn" id="map-location-btn">
                            <i class="fas fa-location-crosshairs"></i>
                            Current Location
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Rent Product Modal -->
    <div class="modal-overlay" id="rent-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Rent Product</h3>
                <button class="modal-close" id="rent-modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="rent-product-id">Product ID</label>
                    <input type="text" class="form-control" id="rent-product-id" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label" for="rent-product-name">Product Name</label>
                    <input type="text" class="form-control" id="rent-product-name" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Your Location</label>
                    <div class="location-inputs">
                        <div class="location-coordinates">
                            <input type="text" class="form-control" id="rent-latitude" placeholder="Latitude" readonly>
                            <input type="text" class="form-control" id="rent-longitude" placeholder="Longitude" readonly>
                        </div>
                        <button type="button" class="btn btn-outline" id="rent-location-btn">
                            <i class="fas fa-map-marker-alt"></i>
                            Get Location
                        </button>
                        <button type="button" class="btn btn-outline" id="rent-copy-location">
                            <i class="fas fa-copy"></i>
                            Copy
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="rent-duration">Rental Duration (hours)</label>
                    <input type="number" class="form-control" id="rent-duration" min="1" value="24">
                    <div class="form-text">Minimum rental period is 1 hour</div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="rent-total">Total Cost</label>
                    <div class="product-price" id="rent-total">
                        <i class="fab fa-ethereum"></i>
                        <span>0.00</span> ETH
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="justify-content: center; gap: 2rem;">
                <button class="btn btn-outline" id="rent-modal-cancel">Cancel</button>
                <button class="btn btn-primary" id="rent-modal-confirm">Confirm Rental</button>
            </div>
        </div>
    </div>

    <!-- Product Details Modal -->
    <div class="modal-overlay" id="details-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Product Details</h3>
                <button class="modal-close" id="details-modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Renter's Address</label>
                    <input type="text" class="form-control" id="details-renter-address" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Rental Start Time</label>
                    <input type="text" class="form-control" id="details-start-time" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Rental Duration</label>
                    <input type="text" class="form-control" id="details-duration" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Location Radius</label>
                    <input type="text" class="form-control" id="details-radius" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Sub-rental Status</label>
                    <div class="details-subrental-status">
                        <span id="details-subrental-allowed" class="badge"></span>
                        <span id="details-subrental-requester" class="text-muted"></span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Commission Rate</label>
                    <input type="text" class="form-control" id="details-commission" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <div id="details-map" style="height: 200px; border-radius: 8px; margin-top: 0.5rem;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="details-modal-close-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Custom Alert System -->
    <div class="alert-overlay" id="alertOverlay"></div>
    <div class="custom-alert" id="customAlert">
        <button class="custom-alert-close" id="alertClose">
            <i class="fas fa-times"></i>
        </button>
        <div class="custom-alert-content">
            <div class="custom-alert-icon">
                <i class="fas fa-info-circle"></i>
            </div>
            <div class="custom-alert-message" id="alertMessage"></div>
        </div>
    </div>

    <script>
        let web3;
        let contract;
        let account;
        //const contractAddress = "0x87cd65f6d1faC2b428B8F928b8FF7Cc7293CEA78";
        //const contractAddress = "0xD443Adcb9dD2BeDe35539584c241F235e86839FF";
        const contractAddress = "0x046056e0f6cacE6824F13664A94BCBeb6391e61E";
        let currentPage = "dashboard";

        // DOM Elements
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebarClose = document.getElementById('sidebar-close');
        const connectWalletBtn = document.getElementById('connect-wallet');
        const rentNowBtn = document.getElementById('rent-now-btn');
        const addProductBtn = document.getElementById('add-product-btn');
        const pageTitle = document.getElementById('page-title');
        const userAddress = document.getElementById('user-address');
        const connectedWalletDisplay = document.getElementById('connected-wallet-display');
        
        // Modal Elements
        const rentModal = document.getElementById('rent-modal');
        const rentModalClose = document.getElementById('rent-modal-close');
        const rentModalCancel = document.getElementById('rent-modal-cancel');
        const rentModalConfirm = document.getElementById('rent-modal-confirm');
        const rentProductId = document.getElementById('rent-product-id');
        const rentProductName = document.getElementById('rent-product-name');
        const rentDuration = document.getElementById('rent-duration');
        const rentLatitude = document.getElementById('rent-latitude');
        const rentLongitude = document.getElementById('rent-longitude');
        const rentTotal = document.getElementById('rent-total').querySelector('span');
        
        // Forms
        const addProductForm = document.getElementById('add-product-form');
        const settingsForm = document.getElementById('settings-form');

        // Initialize the application
        async function init() {
            setupEventListeners();
            await checkWalletConnection();
            initMaps();
            
            // Initialize chatbot
            window.addEventListener("DOMContentLoaded", function() {
                window.AgentInitializer.init({
                    agentRenderURL: "https://agent.jotform.com/0195acef6ba2785686ac249d516aa5d4b50e",
                    rootId: "JotformAgent-0195acef6ba2785686ac249d516aa5d4b50e",
                    formID: "0195acef6ba2785686ac249d516aa5d4b50e",
                    queryParams: ["skipWelcome=1", "maximizable=1"],
                    domain: "https://www.jotform.com",
                    isDraggable: false,
                    background: "linear-gradient(180deg, #D3CBF4 0%, #D3CBF4 100%)",
                    buttonBackgroundColor: "#8797FF",
                    buttonIconColor: "#FFFFFF",
                    variant: false,
                    customizations: {
                        "greeting": "Yes",
                        "greetingMessage": "Hi! How can I assist you?",
                        "openByDefault": "No",
                        "pulse": "Yes",
                        "position": "right",
                        "autoOpenChatIn": "0"
                    },
                    isVoice:true
                });
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Sidebar toggle
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.add('active');
            });
            
            sidebarClose.addEventListener('click', () => {
                sidebar.classList.remove('active');
            });
            
            // Navigation
            document.querySelectorAll('.sidebar-menu-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetPage = link.getAttribute('data-page');
                    navigateToPage(targetPage);
                    
                    // On mobile, close the sidebar after navigation
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('active');
                    }
                });
            });
            
            // Connect wallet button
            connectWalletBtn.addEventListener('click', connectWallet);
            
            // Quick action buttons
            rentNowBtn.addEventListener('click', () => navigateToPage('products'));
            addProductBtn.addEventListener('click', () => navigateToPage('add-product'));
            
            // Modal events
            rentModalClose.addEventListener('click', closeRentModal);
            rentModalCancel.addEventListener('click', closeRentModal);
            rentModalConfirm.addEventListener('click', confirmRental);
            
            // Form submissions
            addProductForm.addEventListener('submit', handleAddProduct);
            settingsForm.addEventListener('submit', handleSaveSettings);
            
            // Rent duration change
            rentDuration.addEventListener('input', updateRentalTotal);
            
            // Setup order filters
            setupOrderFilters();
        }

        // Page navigation
        function navigateToPage(pageName) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
            });
            
            // Show the selected page
            document.getElementById(`${pageName}-page`).classList.remove('hidden');
            
            // Update active link in sidebar
            document.querySelectorAll('.sidebar-menu-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-page') === pageName) {
                    link.classList.add('active');
                }
            });
            
            // Update page title
            pageTitle.textContent = pageName.charAt(0).toUpperCase() + pageName.slice(1).replace('-', ' ');
            
            // Update current page
            currentPage = pageName;
            
            // Show/hide chatbot based on current page
            const chatbotContainer = document.getElementById('JotformAgent-0195acef6ba2785686ac249d516aa5d4b50e');
            if (chatbotContainer) {
                chatbotContainer.style.display = pageName === 'dashboard' ? 'block' : 'none';
            }
            
            // Special handling for map pages
            if (pageName === 'map-view') {
                // Need to refresh the map when it becomes visible
                setTimeout(() => {
                    if (productsMap) {
                        productsMap.invalidateSize();
                        loadProductsOnMap();
                    }
                }, 100);
            } else if (pageName === 'add-product') {
                // Refresh the add product map
                setTimeout(() => {
                    if (addProductMap) {
                        addProductMap.invalidateSize();
                    }
                }, 100);
            }
            
            // Load orders when visiting the orders page
            if (pageName === 'orders') {
                loadOrders();
            }
        }

        // Wallet connection
        async function checkWalletConnection() {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                try {
                    const accounts = await web3.eth.getAccounts();
                    if (accounts.length > 0) {
                        account = accounts[0];
                        updateUIForConnectedWallet();
                        await loadContract();
                        await updateBalance();
                        await loadProducts();
                    } else {
                        updateUIForDisconnectedWallet();
                    }
                } catch (error) {
                    console.error("Error checking wallet connection", error);
                    updateUIForDisconnectedWallet();
                }
            } else {
                console.log("Ethereum provider not found");
                updateUIForDisconnectedWallet();
            }
        }

        async function connectWallet() {
            if (window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    account = accounts[0];
                    updateUIForConnectedWallet();
                    await loadContract();
                    await updateBalance();
                    await loadProducts();
                    await loadOrders(); // Load orders after connecting wallet
                } catch (error) {
                    console.error("Error connecting wallet", error);
                    showAlert("Failed to connect wallet. Please try again.", "error");
                }
            } else {
                showAlert("Please install MetaMask to use this application.", "warning");
            }
        }

        function updateUIForConnectedWallet() {
            connectWalletBtn.innerHTML = `<i class="fas fa-wallet"></i> ${shortenAddress(account)}`;
            userAddress.textContent = shortenAddress(account);
            document.querySelector('.user-role').textContent = "Connected";
            connectedWalletDisplay.textContent = account;
        }

        function updateUIForDisconnectedWallet() {
            connectWalletBtn.innerHTML = `<i class="fas fa-wallet"></i> Connect Wallet`;
            userAddress.textContent = "Not Connected";
            document.querySelector('.user-role').textContent = "Wallet not connected";
            connectedWalletDisplay.textContent = "Not connected";
        }

        // Contract interaction
        async function loadContract() {
            try {
                const response = await fetch("{% static 'ABI2.json' %}");
                const contractABI = await response.json();
                contract = new web3.eth.Contract(contractABI, contractAddress);
            } catch (error) {
                console.error("Error loading contract:", error);
                showAlert("Failed to load contract. Please refresh the page.", "error");
            }
        }

        async function updateBalance() {
            try {
                const balance = await web3.eth.getBalance(account);
                document.getElementById("eth-balance").textContent = parseFloat(web3.utils.fromWei(balance, 'ether')).toFixed(4);
            } catch (error) {
                console.error("Error updating balance:", error);
            }
        }

        async function getProduct(productId) {
            try {
                const product = await contract.methods.products(productId).call();
                
                // Fetch location data from productLocation mapping
                const locationData = await contract.methods.productLocations(productId).call();
                product.latitude = locationData.lat;
                product.longitude = locationData.lon;
                
                return product;
            } catch (error) {
                console.error(`Error fetching product ${productId}:`, error);
                return null;
            }
        }

        async function loadProducts() {
            const productContainer = document.getElementById("product-container");
            const allProductsContainer = document.getElementById("all-products-container");
            
            if (!contract) return;
            
            productContainer.innerHTML = "";
            allProductsContainer.innerHTML = "";
            
            try {
                for (let i = 0; i < 10; i++) { // Load up to 10 products
                    const product = await getProduct(i);
                    if (product && product.name) {
                        // Create product card
                        const productCard = createProductCard(product);
                        
                        // Add to dashboard featured products
                        productContainer.appendChild(productCard.cloneNode(true));
                        
                        // Add to all products page
                        allProductsContainer.appendChild(productCard);
                    }
                }
                
                // Add event listeners to rent buttons
                document.querySelectorAll('.rent-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const productId = e.target.getAttribute('data-id');
                        const productName = e.target.getAttribute('data-name');
                        const productPrice = e.target.getAttribute('data-price');
                        openRentModal(productId, productName, productPrice);
                    });
                });
                
                // Also load products on the map
                await loadProductsOnMap();
            } catch (error) {
                console.error("Error loading products:", error);
            }
        }

        function createProductCard(product) {
            const productCard = document.createElement("div");
            productCard.className = "product-card";
            
            const priceInEth = web3.utils.fromWei(product.priceInWei, 'ether');
            
            productCard.innerHTML = `
                <div class="product-badge ${product.available ? 'available' : 'unavailable'}">
                    ${product.available ? 'Available' : 'Unavailable'}
                </div>
                <div class="product-image">
                    <i class="fas fa-heartbeat"></i>
                </div>
                <div class="product-content">
                    <h3 class="product-title">${product.name}</h3>
                    <div class="product-info">
                        <div class="product-info-item">
                            <span class="product-info-label">Product ID:</span>
                            <span class="product-info-value">#${product.pid}</span>
                        </div>
                        <div class="product-info-item">
                            <span class="product-info-label">Owner:</span>
                            <span class="product-info-value">${shortenAddress(product.owner)}</span>
                        </div>
                    </div>
                    <div class="product-price">
                        <i class="fab fa-ethereum"></i>
                        <span>${priceInEth}</span> ETH/hour
                    </div>
                    <div class="product-actions">
                        <button class="btn btn-primary rent-btn" data-id="${product.pid}" data-name="${product.name}" data-price="${priceInEth}" ${product.available ? '' : 'disabled'}>
                            <i class="fas fa-shopping-cart"></i>
                            Rent Now
                        </button>
                        <button class="btn btn-outline details-btn" data-id="${product.pid}">
                            <i class="fas fa-info-circle"></i>
                            Details
                        </button>
                    </div>
                </div>
            `;
            
            return productCard;
        }

        // Rental modal functions
        function openRentModal(productId, productName, productPrice) {
            rentProductId.value = productId;
            rentProductName.value = productName;
            currentProductPrice = productPrice;
            updateRentalTotal();
            rentModal.classList.add('active');
            
            // Clear location inputs
            document.getElementById('rent-latitude').value = '';
            document.getElementById('rent-longitude').value = '';
        }

        // Get location for rental
        document.getElementById('rent-location-btn').addEventListener('click', function() {
            const button = this;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting Location...';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        document.getElementById('rent-latitude').value = lat.toFixed(6);
                        document.getElementById('rent-longitude').value = lng.toFixed(6);
                        
                        button.innerHTML = originalText;
                        showAlert("Location retrieved successfully!", "success");
                    },
                    function(error) {
                        console.error("Error getting location:", error);
                        showAlert("Unable to retrieve your location. Please check your browser permissions.", "error");
                        button.innerHTML = originalText;
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                showAlert("Geolocation is not supported by this browser.", "error");
                button.innerHTML = originalText;
            }
        });

        // Copy location
        document.getElementById('rent-copy-location').addEventListener('click', function() {
            const lat = document.getElementById('rent-latitude').value;
            const lng = document.getElementById('rent-longitude').value;
            
            if (!lat || !lng) {
                showAlert("No location to copy. Please get your location first.", "warning");
                return;
            }
            
            const locationText = `${lat}, ${lng}`;
            navigator.clipboard.writeText(locationText).then(
                function() {
                    showAlert("Location coordinates copied to clipboard!", "success");
                },
                function(err) {
                    console.error("Could not copy text:", err);
                    showAlert("Failed to copy location. Please try again.", "error");
                }
            );
        });

        function closeRentModal() {
            rentModal.classList.remove('active');
        }

        function updateRentalTotal() {
            const duration = parseInt(rentDuration.value) || 0;
            const total = (parseFloat(currentProductPrice) * duration).toFixed(4);
            rentTotal.textContent = total;
        }

        async function confirmRental() {
            const productId = rentProductId.value;
            const rentLongitude = Math.round(parseFloat(document.getElementById('rent-longitude').value) * 1000000);
            const rentLatitude = Math.round(parseFloat(document.getElementById('rent-latitude').value) * 1000000);
            const duration = parseInt(rentDuration.value);
            
            if (!productId || !duration || duration <= 0) {
                showAlert("Please enter a valid duration", "warning");
                return;
            }
            
            try {
                const product = await getProduct(productId);
                const totalRent = web3.utils.toWei((duration * web3.utils.fromWei(product.priceInWei, 'ether')).toString(), 'ether');
                
                const gasPrice = await web3.eth.getGasPrice();
                const gasEstimate = await contract.methods.rentProduct(productId, duration * 3600, rentLatitude, rentLongitude).estimateGas({ from: account, value: totalRent });

                await contract.methods.rentProduct(productId, duration * 3600, rentLatitude, rentLongitude)
                    .send({ from: account, value: totalRent, gasPrice: gasPrice, gas: gasEstimate });
                
                showAlert("Product rented successfully!", "success");
                closeRentModal();
                await loadProducts();
                await updateBalance();
            } catch (error) {
                console.error("Error renting product:", error);
                showAlert("Transaction failed. Please try again.", "error");
            }
        }

        // Form handlers
        async function handleAddProduct(e) {
            e.preventDefault();
            
            const name = document.getElementById('product-name').value;
            const price = document.getElementById('product-price').value;
            const description = document.getElementById('product-description').value;
            const latitude = document.getElementById('product-latitude').value;
            const longitude = document.getElementById('product-longitude').value;
            const radius = document.getElementById('rental-radius').value;
            const allowSubrenting = document.getElementById('allow-subrenting').checked;
            
            if (!name || !price) {
                showAlert("Please fill in all required fields", "warning");
                return;
            }
            
            if (!latitude || !longitude) {
                showAlert("Please set a location for your product", "warning");
                return;
            }
            
            try {
                const priceInWei = web3.utils.toWei(price.toString(), 'ether');
                
                // Convert latitude and longitude to integers (multiplied by 1e6 to preserve precision)
                const latInt = Math.round(parseFloat(latitude) * 1000000);
                const longInt = Math.round(parseFloat(longitude) * 1000000);
                
                // Add product with sub-renting option
                await contract.methods.addProduct(name, priceInWei, latInt, longInt, radius, allowSubrenting)
                    .send({ from: account });
                
                showAlert("Product added successfully!", "success");
                addProductForm.reset();
                document.getElementById('product-latitude').value = '';
                document.getElementById('product-longitude').value = '';
                document.getElementById('allow-subrenting').checked = false;
                
                // Reset the map
                if (addProductMap) {
                    addProductMap.remove();
                    initAddProductMap();
                }
                
                await loadProducts();
                await loadProductsOnMap();
            } catch (error) {
                console.error("Error adding product:", error);
                showAlert("Failed to add product. Please try again.", "error");
            }
        }

        function handleSaveSettings(e) {
            e.preventDefault();
            
            const name = document.getElementById('user-name').value;
            const email = document.getElementById('user-email').value;
            
            // In a real app, you would save these to a database or local storage
            showAlert("Settings saved successfully!", "success");
        }

        // Utility functions
        function shortenAddress(address) {
            return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
        }

        // Map variables
        let addProductMap = null;
        let addProductMarker = null;
        let productsMap = null;
        let productMarkers = [];
        let radiusCircle = null;

        // Initialize maps
        function initMaps() {
            initAddProductMap();
            initProductsMap();
            initRadiusSelector();
        }

        // Initialize the map in the Add Product form
        function initAddProductMap() {
            if (document.getElementById('location-map')) {
                addProductMap = L.map('location-map').setView([0, 0], 2);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(addProductMap);
                
                // Add click event to set location
                addProductMap.on('click', function(e) {
                    setProductLocation(e.latlng.lat, e.latlng.lng);
                });
                
                // Get location button
                document.getElementById('get-location-btn').addEventListener('click', getCurrentLocation);
            }
        }

        // Initialize the products map
        function initProductsMap() {
            if (document.getElementById('products-map')) {
                productsMap = L.map('products-map').setView([0, 0], 2);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(productsMap);

                // Add event listener for the current location button
                document.getElementById('map-location-btn').addEventListener('click', function() {
                    if (navigator.geolocation) {
                        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Locating...';
                        navigator.geolocation.getCurrentPosition(
                            function(position) {
                                const lat = position.coords.latitude;
                                const lng = position.coords.longitude;
                                
                                // Center map on current location with zoom level 13
                                productsMap.setView([lat, lng], 13);
                                
                                // Add or update the user location marker
                                if (window.userLocationMarker) {
                                    window.userLocationMarker.setLatLng([lat, lng]);
                                } else {
                                    window.userLocationMarker = L.marker([lat, lng], {
                                        icon: L.divIcon({
                                            className: 'user-location-marker',
                                            html: '<i class="fas fa-circle" style="color: var(--primary); font-size: 12px;"></i>',
                                            iconSize: [12, 12],
                                            iconAnchor: [6, 6]
                                        })
                                    }).addTo(productsMap);
                                }
                                
                                // Add or update the accuracy circle
                                if (window.accuracyCircle) {
                                    productsMap.removeLayer(window.accuracyCircle);
                                }
                                window.accuracyCircle = L.circle([lat, lng], {
                                    radius: position.coords.accuracy / 2,
                                    color: 'var(--primary)',
                                    fillColor: 'var(--primary)',
                                    fillOpacity: 0.1,
                                    weight: 1
                                }).addTo(productsMap);

                                // Load nearby products
                                loadNearbyProducts(lat, lng);

                                // Reset button text
                                document.getElementById('map-location-btn').innerHTML = '<i class="fas fa-location-crosshairs"></i> Current Location';
                            },
                            function(error) {
                                console.error("Error getting location:", error);
                                showAlert("Unable to retrieve your location. Please check your browser permissions and try again.", "error");
                                // Reset button text
                                document.getElementById('map-location-btn').innerHTML = '<i class="fas fa-location-crosshairs"></i> Current Location';
                            },
                            {
                                enableHighAccuracy: true,
                                timeout: 5000,
                                maximumAge: 0
                            }
                        );
                    } else {
                        showAlert("Geolocation is not supported by this browser.", "error");
                    }
                });
            }
        }

        // Initialize radius selector
        function initRadiusSelector() {
            const radiusInput = document.getElementById('rental-radius');
            const radiusValue = document.getElementById('radius-value');
            const radiusDisplay = radiusValue.parentElement;
            
            if (radiusInput && radiusValue) {
                // Set initial values
                updateSliderGradient(radiusInput);
                updateValuePosition(radiusInput, radiusDisplay);
                
                radiusInput.addEventListener('input', function() {
                    radiusValue.textContent = this.value;
                    updateSliderGradient(this);
                    updateValuePosition(this, radiusDisplay);
                    updateRadiusCircle();
                });
            }
        }

        // Update slider gradient
        function updateSliderGradient(slider) {
            const value = (slider.value - slider.min) / (slider.max - slider.min) * 100;
            slider.style.setProperty('--range-progress', `${value}%`);
        }

        // Update value bubble position
        function updateValuePosition(slider, valueDisplay) {
            const value = (slider.value - slider.min) / (slider.max - slider.min);
            const position = value * 100;
            valueDisplay.style.setProperty('--value-position', `${position}%`);
        }

        // Update radius circle on map
        function updateRadiusCircle() {
            if (!addProductMap || !addProductMarker) return;
            
            const radius = document.getElementById('rental-radius').value;
            
            // Remove existing circle if any
            if (radiusCircle) {
                addProductMap.removeLayer(radiusCircle);
            }
            
            // Add new circle
            radiusCircle = L.circle(addProductMarker.getLatLng(), {
                radius: radius * 1000, // Convert km to meters
                color: 'var(--primary)',
                fillColor: 'var(--primary)',
                fillOpacity: 0.1,
                weight: 2
            }).addTo(addProductMap);
        }

        // Get current location
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        setProductLocation(lat, lng);
                        
                        // Center map on current location
                        if (addProductMap) {
                            addProductMap.setView([lat, lng], 13);
                        }
                    },
                    function(error) {
                        console.error("Error getting location:", error);
                        alert("Unable to retrieve your location. Please try again or set it manually on the map.");
                    }
                );
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        // Set product location
        function setProductLocation(lat, lng) {
            document.getElementById('product-latitude').value = lat.toFixed(6);
            document.getElementById('product-longitude').value = lng.toFixed(6);
            
            // Update or add marker
            if (addProductMarker) {
                addProductMarker.setLatLng([lat, lng]);
            } else {
                addProductMarker = L.marker([lat, lng]).addTo(addProductMap);
            }
            
            // Update radius circle
            updateRadiusCircle();
        }

        // Load products on map
        async function loadProductsOnMap() {
            if (!productsMap || !contract) return;
            
            // Clear existing markers
            productMarkers.forEach(marker => productsMap.removeLayer(marker));
            productMarkers = [];
            
            // Bounds for auto-zooming
            const bounds = L.latLngBounds();
            let hasProducts = false;
            
            try {
                for (let i = 0; i < 20; i++) { // Load up to 20 products
                    const product = await getProduct(i);
                    if (product && product.name) {
                        // Check if product has location data
                        // Assuming the contract returns lat and long as additional properties
                        // If not, you'll need to modify this based on your contract structure
                        if (product.latitude && product.longitude) {
                            // Convert from integer to float (assuming stored as int * 1e6)
                            const lat = parseInt(product.latitude) / 1000000;
                            const lng = parseInt(product.longitude) / 1000000;
                            
                            if (isNaN(lat) || isNaN(lng)) continue;
                            
                            const marker = L.marker([lat, lng]).addTo(productsMap);
                            
                            // Create popup content
                            const priceInEth = web3.utils.fromWei(product.priceInWei, 'ether');
                            const popupContent = `
                                <div class="map-popup">
                                    <div class="map-popup-title">${product.name}</div>
                                    <div class="map-popup-price"><i class="fab fa-ethereum"></i> ${priceInEth} ETH/hour</div>
                                    <div class="map-popup-status ${product.available ? 'available' : 'unavailable'}">
                                        ${product.available ? 'Available' : 'Unavailable'}
                                    </div>
                                    <div class="map-popup-actions">
                                        <button class="btn btn-primary map-rent-btn" data-id="${product.pid}" ${product.available ? '' : 'disabled'}>
                                            Rent
                                        </button>
                                        <button class="btn btn-outline details-btn" data-id="${product.pid}">Details</button>
                                    </div>
                                </div>
                            `;
                            
                            marker.bindPopup(popupContent);
                            marker.on('click', function() {
                                // Add event listener to rent button in popup
                                setTimeout(() => {
                                    const rentBtn = document.querySelector('.map-rent-btn');
                                    if (rentBtn) {
                                        rentBtn.addEventListener('click', function() {
                                            const productId = this.getAttribute('data-id');
                                            openRentModal(productId, product.name, priceInEth);
                                        });
                                    }
                                    const detailsBtn = document.querySelector('.details-btn');
                                    if (detailsBtn) {
                                        detailsBtn.addEventListener('click', function() {
                                            const productId = this.getAttribute('data-id');
                                            openDetailsModal(productId);
                                        });
                                    }
                                }, 100);
                            });
                            
                            productMarkers.push(marker);
                            bounds.extend([lat, lng]);
                            hasProducts = true;
                        }
                    }
                }
                
                // Fit map to bounds if we have products
                if (hasProducts) {
                    productsMap.fitBounds(bounds, { padding: [50, 50] });
                }
            } catch (error) {
                console.error("Error loading products on map:", error);
            }
        }

        // Initialize the app when the window loads
        window.onload = init;

        // Custom Alert System
        function showAlert(message, type = 'info') {
            const alert = document.getElementById('customAlert');
            const overlay = document.getElementById('alertOverlay');
            const messageEl = document.getElementById('alertMessage');
            const iconEl = alert.querySelector('.custom-alert-icon i');
            
            // Set icon and type
            alert.setAttribute('data-type', type);
            switch(type) {
                case 'success':
                    iconEl.className = 'fas fa-check-circle';
                    break;
                case 'error':
                    iconEl.className = 'fas fa-exclamation-circle';
                    break;
                case 'warning':
                    iconEl.className = 'fas fa-exclamation-triangle';
                    break;
                default:
                    iconEl.className = 'fas fa-info-circle';
            }
            
            messageEl.textContent = message;
            overlay.classList.add('show');
            alert.classList.add('show');
            
            // Auto close after 5 seconds
            setTimeout(() => {
                hideAlert();
            }, 5000);
        }
        
        function hideAlert() {
            const alert = document.getElementById('customAlert');
            const overlay = document.getElementById('alertOverlay');
            alert.classList.remove('show');
            overlay.classList.remove('show');
        }
        
        // Close alert when clicking close button or overlay
        document.getElementById('alertClose').addEventListener('click', hideAlert);
        document.getElementById('alertOverlay').addEventListener('click', hideAlert);

        // Details modal functions
        function openDetailsModal(productId) {
            const modal = document.getElementById('details-modal');
            modal.classList.add('active');
            loadProductDetails(productId);
        }

        function closeDetailsModal() {
            const modal = document.getElementById('details-modal');
            modal.classList.remove('active');
        }

        async function loadProductDetails(productId) {
            try {
                const product = await getProduct(productId);
                if (!product) {
                    showAlert("Error loading product details", "error");
                    return;
                }

                // Update modal fields
                document.getElementById('details-renter-address').value = product.renter || 'No current renter';
                
                // Format start time
                const startTime = product.rentalStartTime > 0 
                    ? new Date(product.rentalStartTime * 1000).toLocaleString()
                    : 'Not currently rented';
                document.getElementById('details-start-time').value = startTime;
                
                // Format duration
                const duration = product.rentalDuration > 0
                    ? `${product.rentalDuration / 3600} hours`
                    : 'Not set';
                document.getElementById('details-duration').value = duration;
                
                // Set radius
                document.getElementById('details-radius').value = `${product.radius} km`;
                
                // Update sub-rental status
                const subrental = document.getElementById('details-subrental-allowed');
                const requester = document.getElementById('details-subrental-requester');
                subrental.className = 'badge ' + (product.subRentAllowed ? 'enabled' : 'disabled');
                subrental.textContent = product.subRentAllowed ? 'Enabled' : 'Disabled';
                
                if (product.subRentRequester && product.subRentRequester !== '0x0000000000000000000000000000000000000000') {
                    requester.textContent = `Requested by: ${shortenAddress(product.subRentRequester)}`;
                } else {
                    requester.textContent = '';
                }
                
                // Set commission rate
                document.getElementById('details-commission').value = `${product.commissionRate}%`;

                // Initialize map
                if (product.latitude && product.longitude) {
                    const lat = parseInt(product.latitude) / 1000000;
                    const lng = parseInt(product.longitude) / 1000000;
                    
                    if (!isNaN(lat) && !isNaN(lng)) {
                        const detailsMap = L.map('details-map').setView([lat, lng], 13);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '© OpenStreetMap contributors'
                        }).addTo(detailsMap);
                        
                        // Add marker
                        L.marker([lat, lng]).addTo(detailsMap);
                        
                        // Add radius circle
                        L.circle([lat, lng], {
                            radius: product.radius * 1000,
                            color: 'var(--primary)',
                            fillColor: 'var(--primary)',
                            fillOpacity: 0.1,
                            weight: 2
                        }).addTo(detailsMap);
                    }
                }
            } catch (error) {
                console.error("Error loading product details:", error);
                showAlert("Failed to load product details", "error");
            }
        }

        // Add event listeners for details modal
        document.getElementById('details-modal-close').addEventListener('click', closeDetailsModal);
        document.getElementById('details-modal-close-btn').addEventListener('click', closeDetailsModal);

        // Update product card event listeners
        function setupProductCardEventListeners() {
            document.querySelectorAll('.details-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const productId = e.target.getAttribute('data-id');
                    openDetailsModal(productId);
                });
            });
        }

        // Update loadProducts function to setup details button listeners
        async function loadProducts() {
            const productContainer = document.getElementById("product-container");
            const allProductsContainer = document.getElementById("all-products-container");
            
            if (!contract) return;
            
            productContainer.innerHTML = "";
            allProductsContainer.innerHTML = "";
            
            try {
                for (let i = 0; i < 10; i++) { // Load up to 10 products
                    const product = await getProduct(i);
                    if (product && product.name) {
                        // Create product card
                        const productCard = createProductCard(product);
                        
                        // Add to dashboard featured products
                        productContainer.appendChild(productCard.cloneNode(true));
                        
                        // Add to all products page
                        allProductsContainer.appendChild(productCard);
                    }
                }
                
                // Add event listeners to rent buttons
                document.querySelectorAll('.rent-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const productId = e.target.getAttribute('data-id');
                        const productName = e.target.getAttribute('data-name');
                        const productPrice = e.target.getAttribute('data-price');
                        openRentModal(productId, productName, productPrice);
                    });
                });
                
                // Setup details button listeners
                setupProductCardEventListeners();
                
                // Also load products on the map
                await loadProductsOnMap();
            } catch (error) {
                console.error("Error loading products:", error);
            }
        }

        // Function to calculate distance between two points
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the earth in km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const d = R * c; // Distance in km
            return d;
        }

        function deg2rad(deg) {
            return deg * (Math.PI/180);
        }

        // Function to load nearby products
        async function loadNearbyProducts(userLat, userLng) {
            if (!contract) return;
            
            // Clear existing markers
            productMarkers.forEach(marker => productsMap.removeLayer(marker));
            productMarkers = [];
            
            try {
                for (let i = 0; i < 20; i++) { // Load up to 20 products
                    const product = await getProduct(i);
                    if (product && product.name && product.available) {
                        // Check if product has location data
                        if (product.latitude && product.longitude) {
                            const lat = parseInt(product.latitude) / 1000000;
                            const lng = parseInt(product.longitude) / 1000000;
                            
                            if (isNaN(lat) || isNaN(lng)) continue;
                            
                            // Calculate distance from user
                            const distance = calculateDistance(userLat, userLng, lat, lng);
                            
                            // Only show products within 50km radius
                            if (distance <= 50) {
                                const marker = L.marker([lat, lng]).addTo(productsMap);
                                
                                // Create popup content
                                const priceInEth = web3.utils.fromWei(product.priceInWei, 'ether');
                                const popupContent = `
                                    <div class="map-popup">
                                        <div class="map-popup-title">${product.name}</div>
                                        <div class="map-popup-price"><i class="fab fa-ethereum"></i> ${priceInEth} ETH/hour</div>
                                        <div class="map-popup-distance">${distance.toFixed(1)} km away</div>
                                        <div class="map-popup-actions">
                                            <button class="btn btn-primary map-rent-btn" data-id="${product.pid}" data-name="${product.name}" data-price="${priceInEth}">
                                                Rent Now
                                            </button>
                                            <button class="btn btn-outline details-btn" data-id="${product.pid}">Details</button>
                                        </div>
                                    </div>
                                `;
                                
                                marker.bindPopup(popupContent);
                                
                                // Add click event to rent button in popup
                                marker.on('click', function() {
                                    setTimeout(() => {
                                        const rentBtn = document.querySelector('.map-rent-btn');
                                        if (rentBtn) {
                                            rentBtn.addEventListener('click', function() {
                                                const productId = this.getAttribute('data-id');
                                                const productName = this.getAttribute('data-name');
                                                const productPrice = this.getAttribute('data-price');
                                                openRentModal(productId, productName, productPrice);
                                            });
                                        }
                                        const detailsBtn = document.querySelector('.details-btn');
                                        if (detailsBtn) {
                                            detailsBtn.addEventListener('click', function() {
                                                const productId = this.getAttribute('data-id');
                                                openDetailsModal(productId);
                                            });
                                        }
                                    }, 100);
                                });
                                
                                productMarkers.push(marker);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error("Error loading nearby products:", error);
                showAlert("Failed to load nearby products", "error");
            }
        }

        // Update the Orders page content loading
        async function loadOrders(filterType = 'all') {
            const ordersTableBody = document.getElementById('orders-table-body');
            ordersTableBody.innerHTML = '';
            
            if (!contract || !account) {
                showAlert("Please connect your wallet first", "warning");
                return;
            }
            
            try {
                const ownedProducts = [];
                const rentedProducts = [];
                
                // Iterate through products
                for (let i = 0; i < 20; i++) {
                    const product = await getProduct(i);
                    if (product && product.name) {
                        if (product.owner.toLowerCase() === account.toLowerCase()) {
                            ownedProducts.push({ ...product, pid: i });
                        } else if (product.renter && product.renter.toLowerCase() === account.toLowerCase()) {
                            rentedProducts.push({ ...product, pid: i });
                        }
                    }
                }
                
                // Filter products based on selected filter
                let productsToShow = [];
                switch (filterType) {
                    case 'owned':
                        productsToShow = ownedProducts;
                        break;
                    case 'rented':
                        productsToShow = rentedProducts;
                        break;
                    case 'active':
                        const currentTime = Math.floor(Date.now() / 1000);
                        productsToShow = [...ownedProducts, ...rentedProducts].filter(product => {
                            const rentalEndTime = parseInt(product.rentalStartTime) + parseInt(product.rentalDuration);
                            return !product.available && currentTime < rentalEndTime;
                        });
                        break;
                    case 'available':
                        productsToShow = ownedProducts.filter(product => product.available);
                        break;
                    default: // 'all'
                        productsToShow = [...ownedProducts, ...rentedProducts];
                }
                
                // Display filtered products
                if (productsToShow.length === 0) {
                    ordersTableBody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center;">No products found for selected filter</td>
                        </tr>
                    `;
                    return;
                }
                
                // Sort products by rental start time (most recent first)
                productsToShow.sort((a, b) => b.rentalStartTime - a.rentalStartTime);
                
                for (const product of productsToShow) {
                    const row = document.createElement('tr');
                    const status = getProductStatus(product);
                    const isRented = product.renter.toLowerCase() === account.toLowerCase();
                    
                    row.innerHTML = `
                        <td>#${product.pid}</td>
                        <td>${product.name}${isRented ? ' (Rented)' : ''}</td>
                        <td>${formatTimestamp(product.rentalStartTime)}</td>
                        <td>${web3.utils.fromWei(product.priceInWei, 'ether')} ETH/hr</td>
                        <td><span class="status-badge ${status.class}"><i class="${status.icon}"></i> ${status.text}</span></td>
                        <td>
                            <button class="btn btn-outline btn-sm details-btn" data-id="${product.pid}">View</button>
                        </td>
                    `;
                    ordersTableBody.appendChild(row);
                }
                
                // Setup details button listeners
                document.querySelectorAll('.details-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const productId = e.target.getAttribute('data-id');
                        openDetailsModal(productId);
                    });
                });
                
            } catch (error) {
                console.error("Error loading orders:", error);
                showAlert("Failed to load orders", "error");
            }
        }

        // Helper function to determine product status
        function getProductStatus(product) {
            if (!product.available && product.renter !== '0x0000000000000000000000000000000000000000') {
                const currentTime = Math.floor(Date.now() / 1000);
                const rentalEndTime = parseInt(product.rentalStartTime) + parseInt(product.rentalDuration);
                
                if (currentTime < rentalEndTime) {
                    return {
                        class: 'approved',
                        icon: 'fas fa-clock',
                        text: 'Active Rental'
                    };
                } else {
                    return {
                        class: 'returned',
                        icon: 'fas fa-check',
                        text: 'Completed'
                    };
                }
            } else if (product.available) {
                return {
                    class: 'pending',
                    icon: 'fas fa-circle',
                    text: 'Available'
                };
            } else {
                return {
                    class: 'cancelled',
                    icon: 'fas fa-times',
                    text: 'Unavailable'
                };
            }
        }

        // Helper function to format timestamp
        function formatTimestamp(timestamp) {
            if (!timestamp || timestamp === '0') {
                return 'N/A';
            }
            return new Date(timestamp * 1000).toLocaleString();
        }

        // Add this JavaScript function to handle filtering
        function setupOrderFilters() {
            const filterOptions = document.querySelectorAll('#orders-page .filter-options .filter-option');
            
            filterOptions.forEach(option => {
                option.addEventListener('click', async function() {
                    // Update active state
                    filterOptions.forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Get filter type
                    const filterType = this.getAttribute('data-filter');
                    
                    // Reload orders with filter
                    await loadOrders(filterType);
                });
            });
        }
    </script>
</body>
</html>

