{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medichain - Rental DApp</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.5/web3.min.js"></script>
    <script src='https://cdn.jotfor.ms/s/umd/latest/for-embedded-agent.js'></script>
    <link rel="stylesheet" href="{% static 'index.css' %}">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/" style="text-decoration: none;">
                <div class="logo">
                    <i class="fas fa-link" style="color: var(--primary);"></i>
                    <span>Medichain</span>
                </div>
                </a>
                <button class="sidebar-toggle" id="sidebar-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="sidebar-content">
                <ul class="sidebar-menu">
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link active" data-page="dashboard">
                            <i class="fas fa-th-large"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link" data-page="products">
                            <i class="fas fa-box"></i>
                            <span>Products</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link" data-page="add-product">
                            <i class="fas fa-plus-circle"></i>
                            <span>Add Product</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link" data-page="orders">
                            <i class="fas fa-clipboard-list"></i>
                            <span>Orders</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link" data-page="map-view">
                            <i class="fas fa-map-marked-alt"></i>
                            <span>Map View</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link" data-page="certifications">
                            <i class="fas fa-certificate"></i>
                            <span>Certifications</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link" data-page="settings">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                </ul>
            </div>
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-details">
                        <div class="user-name" id="user-address">Not Connected</div>
                        <div class="user-role">Wallet not connected</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <button class="sidebar-toggle" id="sidebar-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title" id="page-title">Dashboard</h1>
                <div class="header-actions">
                    <div class="balance-display">
                        <i class="fab fa-ethereum"></i>
                        <span id="eth-balance">0</span> ETH
                    </div>
                    <button class="btn btn-primary" id="connect-wallet">
                        <i class="fas fa-wallet"></i>
                        Connect Wallet
                    </button>
                </div>
            </header>

            <div class="content">
                <!-- Dashboard Page -->
                <div class="page" id="dashboard-page">
                    <div class="dashboard">
                        <div class="dashboard-header">
                            <h2 class="dashboard-title">Dashboard Overview</h2>
                            <div class="dashboard-actions">
                                <button class="btn btn-primary" id="rent-now-btn">
                                    <i class="fas fa-shopping-cart"></i>
                                    Rent Now
                                </button>
                                <button class="btn btn-outline" id="add-product-btn">
                                    <i class="fas fa-plus"></i>
                                    Add Product
                                </button>
                            </div>
                        </div>

                        <script>
                          window.addEventListener("DOMContentLoaded", function() {
                            window.AgentInitializer.init({
                              agentRenderURL: "https://agent.jotform.com/0195acef6ba2785686ac249d516aa5d4b50e",
                              rootId: "JotformAgent-0195acef6ba2785686ac249d516aa5d4b50e",
                              formID: "0195acef6ba2785686ac249d516aa5d4b50e",
                              queryParams: ["skipWelcome=1", "maximizable=1"],
                              domain: "https://www.jotform.com",
                              isDraggable: false,
                              background: "linear-gradient(180deg, #D3CBF4 0%, #D3CBF4 100%)",
                              buttonBackgroundColor: "#8797FF",
                              buttonIconColor: "#FFFFFF",
                              variant: false,
                              customizations: {
                                "greeting": "Yes",
                                "greetingMessage": "Hi! How can I assist you?",
                                "openByDefault": "No",
                                "pulse": "Yes",
                                "position": "right",
                                "autoOpenChatIn": "0"
                              },
                              isVoice: undefined
                            });
                          });
                        </script>

                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-title">Total Products</div>
                                    <div class="stat-icon blue">
                                        <i class="fas fa-box"></i>
                                    </div>
                                </div>
                                <div class="stat-value">0</div>
                                <div class="stat-change positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>0% from last month</span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-title">Active Rentals</div>
                                    <div class="stat-icon green">
                                        <i class="fas fa-handshake"></i>
                                    </div>
                                </div>
                                <div class="stat-value">0</div>
                                <div class="stat-change positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>0% from last month</span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-title">Pending Orders</div>
                                    <div class="stat-icon orange">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                </div>
                                <div class="stat-value">0</div>
                                <div class="stat-change negative">
                                    <i class="fas fa-arrow-down"></i>
                                    <span>0% from last month</span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-title">Total Revenue</div>
                                    <div class="stat-icon blue">
                                        <i class="fab fa-ethereum"></i>
                                    </div>
                                </div>
                                <div class="stat-value">0.000 ETH</div>
                                <div class="stat-change positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>0% from last month</span>
                                </div>
                            </div>
                        </div>

                        <div class="section-header">
                            <h3 class="section-title">Featured Products</h3>
                            <div class="filter-options">
                                <div class="filter-option active">All</div>
                                <div class="filter-option">Available</div>
                                <div class="filter-option">Medical</div>
                                <div class="filter-option">Equipment</div>
                            </div>
                        </div>

                        <div class="product-grid" id="product-container">
                            <!-- Products will be loaded here dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Products Page -->
                <div class="page hidden" id="products-page">
                    <div class="section-header">
                        <h2 class="dashboard-title">All Products</h2>
                        <div class="filter-options">
                            <div class="filter-option active">All</div>
                            <div class="filter-option">Available</div>
                            <div class="filter-option">Unavailable</div>
                        </div>
                    </div>
                    <div class="product-grid" id="all-products-container">
                        <!-- All products will be loaded here -->
                    </div>
                </div>

                <!-- Add Product Page -->
                <div class="page hidden" id="add-product-page">
                    <div class="dashboard-header">
                        <h2 class="dashboard-title">Add New Product</h2>
                    </div>
                    <div class="form-container">
                        <form id="add-product-form">
                            <div class="form-group">
                                <label class="form-label" for="product-name">Product Name</label>
                                <input type="text" class="form-control" id="product-name" placeholder="Enter product name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="product-price">Price (ETH)</label>
                                <input type="number" class="form-control" id="product-price" placeholder="0.01" step="0.001" min="0" required>
                                <div class="form-text">Price per hour in ETH</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="product-description">Description</label>
                                <textarea class="form-control" id="product-description" rows="4" placeholder="Enter product description"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Location</label>
                                <div class="location-inputs">
                                    <div class="location-coordinates">
                                        <input type="text" class="form-control" id="product-latitude" placeholder="Latitude" readonly>
                                        <input type="text" class="form-control" id="product-longitude" placeholder="Longitude" readonly>
                                    </div>
                                    <button type="button" class="btn btn-outline" id="get-location-btn">
                                        <i class="fas fa-map-marker-alt"></i>
                                        Get Current Location
                                    </button>
                                </div>
                                <div class="form-text">Click the button to automatically fetch your current location</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="rental-radius">Rental Radius (km)</label>
                                <div class="radius-selector">
                                    <input type="range" class="form-control" id="rental-radius" min="1" max="50" value="5" step="1">
                                    <div class="radius-value-display">
                                        <span id="radius-value">5</span> km
                                    </div>
                                </div>
                                <div class="form-text">Select the radius within which you want to rent your product</div>
                            </div>
                            <div class="form-group">
                                <div class="toggle-container">
                                    <label class="toggle-label">
                                        Allow Sub-renting
                                        <div class="info-icon">
                                            <i class="fas fa-info-circle"></i>
                                            <div class="info-tooltip">
                                                Sub-renting allows the renter to rent this product to other users while they have it rented, creating a rental chain. You'll still earn your original rental fee.
                                            </div>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="allow-subrenting">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <div id="location-map" style="height: 300px; border-radius: 12px;"></div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus-circle"></i>
                                Add Product
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Orders Page -->
                <div class="page hidden" id="orders-page">
                    <div class="dashboard-header">
                        <h2 class="dashboard-title">Order Status</h2>
                        <div class="header-actions">
                        <div class="filter-options">
                            <div class="filter-option active" data-filter="all">All</div>
                            <div class="filter-option" data-filter="owned">My Products</div>
                            <div class="filter-option" data-filter="rented">Rented by Me</div>
                            <div class="filter-option" data-filter="active">Active Rentals</div>
                            <div class="filter-option" data-filter="available">Available</div>
                            </div>
                            <button class="btn btn-primary return-product-btn" id="return-product-btn">
                                <i class="fas fa-undo"></i>
                                Return Product
                            </button>
                        </div>
                    </div>
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Product</th>
                                <th>Date</th>
                                <th>Price</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body">
                            <!-- Orders will be dynamically added here -->
                        </tbody>
                    </table>
                </div>

                <!-- Settings Page -->
                <div class="page hidden" id="settings-page">
                    <div class="dashboard-header">
                        <h2 class="dashboard-title">Settings</h2>
                    </div>
                    <div class="form-container">
                        <form id="settings-form">
                            <div class="form-group">
                                <label class="form-label" for="user-name">Display Name</label>
                                <input type="text" class="form-control" id="user-name" placeholder="Enter your name">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="user-email">Email</label>
                                <input type="email" class="form-control" id="user-email" placeholder="Enter your email">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Connected Wallet</label>
                                <div class="form-control" id="connected-wallet-display">Not connected</div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i>
                                Save Settings
                            </button>
                        </form>
                    </div>
                </div>
                <!-- Map View Page -->
                <div class="page hidden" id="map-view-page">
                    <div class="dashboard-header">
                        <h2 class="dashboard-title">Product Map</h2>
                        <div class="filter-options">
                            <div class="filter-option active">All Products</div>
                            <div class="filter-option">Available Only</div>
                            <div class="filter-option">My Products</div>
                        </div>
                    </div>
                    <div class="map-container" style="position: relative;">
                        <div id="products-map" style="height: 600px; border-radius: 12px;"></div>
                        <button class="btn btn-primary map-location-btn" id="map-location-btn">
                            <i class="fas fa-location-crosshairs"></i>
                            Current Location
                        </button>
                    </div>
                </div>
                <!-- Add this after the dashboard-page div -->
                <div class="page hidden" id="certifications-page">
                    <div class="dashboard-header">
                        <h2 class="dashboard-title">Equipment Certifications</h2>
                    </div>
                    <div class="cert-controls">
                        <div class="search-input-container">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" placeholder="Search certificates..." class="search-input" id="cert-search">
                        </div>
                        <select class="select-input" id="cert-type-filter">
                            <option value="all">All Types</option>
                            <option value="imaging">Imaging Equipment</option>
                            <option value="monitoring">Monitoring Devices</option>
                            <option value="surgical">Surgical Tools</option>
                            <option value="diagnostic">Diagnostic Equipment</option>
                        </select>
                    </div>
                    <div class="certificates-grid" id="certificates-container">
                        <!-- Certificates will be loaded here dynamically -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Rent Product Modal -->
    <div class="modal-overlay" id="rent-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Rent Product</h3>
                <button class="modal-close" id="rent-modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="rent-product-id">Product ID</label>
                    <input type="text" class="form-control" id="rent-product-id" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label" for="rent-product-name">Product Name</label>
                    <input type="text" class="form-control" id="rent-product-name" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Your Location</label>
                    <div class="location-inputs">
                        <div class="location-coordinates">
                            <input type="text" class="form-control" id="rent-latitude" placeholder="Latitude" readonly>
                            <input type="text" class="form-control" id="rent-longitude" placeholder="Longitude" readonly>
                        </div>
                        <button type="button" class="btn btn-outline" id="rent-location-btn">
                            <i class="fas fa-map-marker-alt"></i>
                            Get Location
                        </button>
                        <button type="button" class="btn btn-outline" id="rent-copy-location">
                            <i class="fas fa-copy"></i>
                            Copy
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="rent-duration">Rental Duration (hours)</label>
                    <input type="number" class="form-control" id="rent-duration" min="1" value="24">
                    <div class="form-text">Minimum rental period is 1 hour</div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="rent-total">Total Cost</label>
                    <div class="product-price" id="rent-total">
                        <i class="fab fa-ethereum"></i>
                        <span>0.00</span> ETH
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="justify-content: center; gap: 2rem;">
                <button class="btn btn-outline" id="rent-modal-cancel">Cancel</button>
                <button class="btn btn-primary" id="rent-modal-confirm">Confirm Rental</button>
            </div>
        </div>
    </div>

    <!-- Product Details Modal -->
    <div class="modal-overlay" id="details-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Product Details</h3>
                <button class="modal-close" id="details-modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Renter's Address</label>
                    <input type="text" class="form-control" id="details-renter-address" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Rental Start Time</label>
                    <input type="text" class="form-control" id="details-start-time" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Rental Duration</label>
                    <input type="text" class="form-control" id="details-duration" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Location Radius</label>
                    <input type="text" class="form-control" id="details-radius" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Sub-rental Status</label>
                    <div class="details-subrental-status">
                        <span id="details-subrental-allowed" class="badge"></span>
                        <span id="details-subrental-requester" class="text-muted"></span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Commission Rate</label>
                    <input type="text" class="form-control" id="details-commission" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <div id="details-map" style="height: 200px; border-radius: 8px; margin-top: 0.5rem;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="details-modal-close-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Custom Alert System -->
    <div class="alert-overlay" id="alertOverlay"></div>
    <div class="custom-alert" id="customAlert">
        <button class="custom-alert-close" id="alertClose">
            <i class="fas fa-times"></i>
        </button>
        <div class="custom-alert-content">
            <div class="custom-alert-icon">
                <i class="fas fa-info-circle"></i>
            </div>
            <div class="custom-alert-message" id="alertMessage"></div>
        </div>
    </div>

    <!-- Return Product Modal -->
    <div class="modal-overlay" id="return-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Return Product</h3>
                <button class="modal-close" id="return-modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="return-product-id">Product ID</label>
                    <input type="text" class="form-control" id="return-product-id" placeholder="Enter product ID">
                    <div class="form-text">Please enter the ID of the product you want to return</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Return Location</label>
                    <div class="location-coordinates">
                        <input type="text" class="form-control" id="return-latitude" placeholder="Latitude" readonly>
                        <input type="text" class="form-control" id="return-longitude" placeholder="Longitude" readonly>
                    </div>
                    <div class="form-text">Your current location will be used as the return location</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="return-modal-cancel">Cancel</button>
                <button class="btn btn-primary" id="return-modal-confirm">
                    <i class="fas fa-undo"></i>
                    Confirm Return
                </button>
            </div>
        </div>
    </div>

    <script>
        let web3;
        let contract;
        let account;
        //const contractAddress = "0x87cd65f6d1faC2b428B8F928b8FF7Cc7293CEA78";
        //const contractAddress = "0xD443Adcb9dD2BeDe35539584c241F235e86839FF";
        const contractAddress = "0x046056e0f6cacE6824F13664A94BCBeb6391e61E";
        let currentPage = "dashboard";

        // DOM Elements
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebarClose = document.getElementById('sidebar-close');
        const connectWalletBtn = document.getElementById('connect-wallet');
        const rentNowBtn = document.getElementById('rent-now-btn');
        const addProductBtn = document.getElementById('add-product-btn');
        const pageTitle = document.getElementById('page-title');
        const userAddress = document.getElementById('user-address');
        const connectedWalletDisplay = document.getElementById('connected-wallet-display');
        
        // Modal Elements
        const rentModal = document.getElementById('rent-modal');
        const rentModalClose = document.getElementById('rent-modal-close');
        const rentModalCancel = document.getElementById('rent-modal-cancel');
        const rentModalConfirm = document.getElementById('rent-modal-confirm');
        const rentProductId = document.getElementById('rent-product-id');
        const rentProductName = document.getElementById('rent-product-name');
        const rentDuration = document.getElementById('rent-duration');
        const rentLatitude = document.getElementById('rent-latitude');
        const rentLongitude = document.getElementById('rent-longitude');
        const rentTotal = document.getElementById('rent-total').querySelector('span');
        
        // Forms
        const addProductForm = document.getElementById('add-product-form');
        const settingsForm = document.getElementById('settings-form');

        // Initialize the application
        async function init() {
            setupEventListeners();
            await checkWalletConnection();
            initMaps();
            await loadDashboardStats();
            
            // Initialize chatbot
            window.addEventListener("DOMContentLoaded", function() {
                window.AgentInitializer.init({
                    agentRenderURL: "https://agent.jotform.com/0195acef6ba2785686ac249d516aa5d4b50e",
                    rootId: "JotformAgent-0195acef6ba2785686ac249d516aa5d4b50e",
                    formID: "0195acef6ba2785686ac249d516aa5d4b50e",
                    queryParams: ["skipWelcome=1", "maximizable=1"],
                    domain: "https://www.jotform.com",
                    isDraggable: false,
                    background: "linear-gradient(180deg, #D3CBF4 0%, #D3CBF4 100%)",
                    buttonBackgroundColor: "#8797FF",
                    buttonIconColor: "#FFFFFF",
                    variant: false,
                    customizations: {
                        "greeting": "Yes",
                        "greetingMessage": "Hi! How can I assist you?",
                        "openByDefault": "No",
                        "pulse": "Yes",
                        "position": "right",
                        "autoOpenChatIn": "0"
                    },
                    isVoice:true
                });
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Sidebar toggle
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.add('active');
            });
            
            sidebarClose.addEventListener('click', () => {
                sidebar.classList.remove('active');
            });
            
            // Navigation
            document.querySelectorAll('.sidebar-menu-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetPage = link.getAttribute('data-page');
                    navigateToPage(targetPage);
                    
                    // On mobile, close the sidebar after navigation
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('active');
                    }
                });
            });
            
            // Connect wallet button
            connectWalletBtn.addEventListener('click', connectWallet);
            
            // Quick action buttons
            rentNowBtn.addEventListener('click', () => navigateToPage('products'));
            addProductBtn.addEventListener('click', () => navigateToPage('add-product'));
            
            // Modal events
            rentModalClose.addEventListener('click', closeRentModal);
            rentModalCancel.addEventListener('click', closeRentModal);
            rentModalConfirm.addEventListener('click', confirmRental);
            
            // Form submissions
            addProductForm.addEventListener('submit', handleAddProduct);
            settingsForm.addEventListener('submit', handleSaveSettings);
            
            // Rent duration change
            rentDuration.addEventListener('input', updateRentalTotal);
            
            // Setup order filters
            setupOrderFilters();

            // Add return product button listener
            document.getElementById('return-product-btn').addEventListener('click', handleReturnProductClick);

            // Return modal events
            document.getElementById('return-modal-close').addEventListener('click', closeReturnModal);
            document.getElementById('return-modal-cancel').addEventListener('click', closeReturnModal);
            document.getElementById('return-modal-confirm').addEventListener('click', handleReturnConfirm);
        }

        // Page navigation
        function navigateToPage(pageName) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
            });
            
            // Show the selected page
            document.getElementById(`${pageName}-page`).classList.remove('hidden');
            
            // Update active link in sidebar
            document.querySelectorAll('.sidebar-menu-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-page') === pageName) {
                    link.classList.add('active');
                }
            });
            
            // Update page title
            pageTitle.textContent = pageName.charAt(0).toUpperCase() + pageName.slice(1).replace('-', ' ');
            
            // Update current page
            currentPage = pageName;
            
            // Show/hide chatbot based on current page
            const chatbotContainer = document.getElementById('JotformAgent-0195acef6ba2785686ac249d516aa5d4b50e');
            if (chatbotContainer) {
                chatbotContainer.style.display = pageName === 'dashboard' ? 'block' : 'none';
            }
            
            // Special handling for map pages
            if (pageName === 'map-view') {
                // Need to refresh the map when it becomes visible
                setTimeout(() => {
                    if (productsMap) {
                        productsMap.invalidateSize();
                        loadProductsOnMap();
                    }
                }, 100);
            } else if (pageName === 'add-product') {
                // Refresh the add product map
                setTimeout(() => {
                    if (addProductMap) {
                        addProductMap.invalidateSize();
                    }
                }, 100);
            }
            
            // Load orders when visiting the orders page
            if (pageName === 'orders') {
                loadOrders();
            }
            
            if (pageName === 'dashboard') {
                loadDashboardStats();
            }
        }

        // Wallet connection
        async function checkWalletConnection() {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                try {
                    const accounts = await web3.eth.getAccounts();
                    if (accounts.length > 0) {
                        account = accounts[0];
                        updateUIForConnectedWallet();
                        await loadContract();
                        await updateBalance();
                        await loadProducts();
                    } else {
                        updateUIForDisconnectedWallet();
                    }
                } catch (error) {
                    console.error("Error checking wallet connection", error);
                    updateUIForDisconnectedWallet();
                }
            } else {
                console.log("Ethereum provider not found");
                updateUIForDisconnectedWallet();
            }
        }

        async function connectWallet() {
            if (window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    account = accounts[0];
                    updateUIForConnectedWallet();
                    await loadContract();
                    await updateBalance();
                    await loadProducts();
                    await loadOrders(); // Load orders after connecting wallet
                } catch (error) {
                    console.error("Error connecting wallet", error);
                    showAlert("Failed to connect wallet. Please try again.", "error");
                }
            } else {
                showAlert("Please install MetaMask to use this application.", "warning");
            }
        }

        function updateUIForConnectedWallet() {
            connectWalletBtn.innerHTML = `<i class="fas fa-wallet"></i> ${shortenAddress(account)}`;
            userAddress.textContent = shortenAddress(account);
            document.querySelector('.user-role').textContent = "Connected";
            connectedWalletDisplay.textContent = account;
        }

        function updateUIForDisconnectedWallet() {
            connectWalletBtn.innerHTML = `<i class="fas fa-wallet"></i> Connect Wallet`;
            userAddress.textContent = "Not Connected";
            document.querySelector('.user-role').textContent = "Wallet not connected";
            connectedWalletDisplay.textContent = "Not connected";
        }

        // Contract interaction
        async function loadContract() {
            try {
                const response = await fetch("{% static 'ABI2.json' %}");
                const contractABI = await response.json();
                contract = new web3.eth.Contract(contractABI, contractAddress);
            } catch (error) {
                console.error("Error loading contract:", error);
                showAlert("Failed to load contract. Please refresh the page.", "error");
            }
        }

        async function updateBalance() {
            try {
                const balance = await web3.eth.getBalance(account);
                document.getElementById("eth-balance").textContent = parseFloat(web3.utils.fromWei(balance, 'ether')).toFixed(4);
            } catch (error) {
                console.error("Error updating balance:", error);
            }
        }

        async function getProduct(productId) {
            try {
                const product = await contract.methods.products(productId).call();
                
                // Fetch location data from productLocation mapping
                const locationData = await contract.methods.productLocations(productId).call();
                product.latitude = locationData.lat;
                product.longitude = locationData.lon;
                
                return product;
            } catch (error) {
                console.error(`Error fetching product ${productId}:`, error);
                return null;
            }
        }

        async function loadProducts() {
            const productContainer = document.getElementById("product-container");
            const allProductsContainer = document.getElementById("all-products-container");
            
            if (!contract) return;
            
            productContainer.innerHTML = "";
            allProductsContainer.innerHTML = "";
            
            try {
                for (let i = 0; i < 10; i++) {
                    const product = await getProduct(i);
                    if (product && product.name) {
                        // Create product card
                        const productCard = createProductCard(product);
                        const productCardClone = productCard.cloneNode(true);
                        
                        // Add event listeners to the original card
                        setupCardEventListeners(productCard, product);
                        // Add event listeners to the cloned card
                        setupCardEventListeners(productCardClone, product);
                        
                        // Add to dashboard featured products
                        productContainer.appendChild(productCardClone);
                        
                        // Add to all products page
                        allProductsContainer.appendChild(productCard);
                    }
                }
                
                // Also load products on the map
                await loadProductsOnMap();
                await loadDashboardStats();
            } catch (error) {
                console.error("Error loading products:", error);
                showAlert("Failed to load products", "error");
            }
        }

        // Update the createProductCard function to handle sub-rentable products
        function createProductCard(product) {
            const productCard = document.createElement("div");
            productCard.className = "product-card";
            
            const priceInEth = web3.utils.fromWei(product.priceInWei, 'ether');
            const isSubRentable = !product.available && product.subRentAllowed;
            
            productCard.innerHTML = `
                <div class="product-badge ${product.available ? 'available' : isSubRentable ? 'sub-rentable' : 'unavailable'}">
                    ${product.available ? 'Available' : isSubRentable ? 'Available for Sub-rent' : 'Unavailable'}
                </div>
                <div class="product-image">
                    <i class="fas fa-heartbeat"></i>
                </div>
                <div class="product-content">
                    <h3 class="product-title">${product.name}</h3>
                    <div class="product-info">
                        <div class="product-info-item">
                            <span class="product-info-label">Product ID:</span>
                            <span class="product-info-value">#${product.pid}</span>
                        </div>
                        <div class="product-info-item">
                            <span class="product-info-label">Owner:</span>
                            <span class="product-info-value">${shortenAddress(product.owner)}</span>
                        </div>
                        ${isSubRentable ? `
                        <div class="product-info-item">
                            <span class="product-info-label">Current Renter:</span>
                            <span class="product-info-value">${shortenAddress(product.renter)}</span>
                        </div>
                        ` : ''}
                    </div>
                    <div class="product-price">
                        <i class="fab fa-ethereum"></i>
                        <span>${priceInEth}</span> ETH/hour
                        ${isSubRentable ? '<span class="sub-rent-badge">Sub-rentable</span>' : ''}
                    </div>
                    <div class="product-actions">
                        <button class="btn btn-primary rent-btn" 
                            data-id="${product.pid}" 
                            data-name="${product.name}" 
                            data-price="${priceInEth}" 
                            ${(!product.available && !isSubRentable) ? 'disabled' : ''}>
                            <i class="fas fa-shopping-cart"></i>
                            ${isSubRentable ? 'Sub-rent Now' : 'Rent Now'}
                        </button>
                        <button class="btn btn-outline details-btn" data-id="${product.pid}">
                            <i class="fas fa-info-circle"></i>
                            Details
                        </button>
                    </div>
                </div>
            `;
            
            return productCard;
        }

        // Add these styles to your existing style element
        const subRentStyles = `
            .sub-rentable {
                background: rgba(124, 58, 237, 0.2) !important;
                color: var(--primary) !important;
                border: 1px solid var(--primary) !important;
            }

            .sub-rent-badge {
                display: inline-block;
                padding: 0.2rem 0.5rem;
                background: rgba(124, 58, 237, 0.1);
                color: var(--primary);
                border-radius: 4px;
                font-size: 0.75rem;
                margin-left: 0.5rem;
                border: 1px solid rgba(124, 58, 237, 0.2);
            }

            .product-card:hover .sub-rent-badge {
                background: rgba(124, 58, 237, 0.2);
            }

            .product-info-item {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                margin-bottom: 0.25rem;
            }

            .product-info-label {
                color: var(--text-secondary);
                font-size: 0.875rem;
            }

            .product-info-value {
                color: var(--text-primary);
                font-size: 0.875rem;
                font-weight: 500;
            }
        `;

        document.head.appendChild(document.createElement('style')).textContent = subRentStyles;

        // Add this new helper function to setup event listeners
        function setupCardEventListeners(card, product) {
            // Setup rent button
            const rentBtn = card.querySelector('.rent-btn');
            if (rentBtn) {
                rentBtn.addEventListener('click', () => {
                    const productId = rentBtn.getAttribute('data-id');
                    const productName = rentBtn.getAttribute('data-name');
                    const productPrice = rentBtn.getAttribute('data-price');
                    openRentModal(productId, productName, productPrice);
                });
            }
            
            // Setup details button
            const detailsBtn = card.querySelector('.details-btn');
            if (detailsBtn) {
                detailsBtn.addEventListener('click', () => {
                    const productId = detailsBtn.getAttribute('data-id');
                    openDetailsModal(productId);
                });
            }
        }

        // Rental modal functions
        function openRentModal(productId, productName, productPrice) {
            rentProductId.value = productId;
            rentProductName.value = productName;
            currentProductPrice = productPrice;
            updateRentalTotal();
            rentModal.classList.add('active');
            
            // Clear location inputs
            document.getElementById('rent-latitude').value = '';
            document.getElementById('rent-longitude').value = '';
        }

        // Get location for rental
        document.getElementById('rent-location-btn').addEventListener('click', function() {
            const button = this;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting Location...';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        document.getElementById('rent-latitude').value = lat.toFixed(6);
                        document.getElementById('rent-longitude').value = lng.toFixed(6);
                        
                        button.innerHTML = originalText;
                        showAlert("Location retrieved successfully!", "success");
                    },
                    function(error) {
                        console.error("Error getting location:", error);
                        showAlert("Unable to retrieve your location. Please check your browser permissions.", "error");
                        button.innerHTML = originalText;
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                showAlert("Geolocation is not supported by this browser.", "error");
                button.innerHTML = originalText;
            }
        });

        // Copy location
        document.getElementById('rent-copy-location').addEventListener('click', function() {
            const lat = document.getElementById('rent-latitude').value;
            const lng = document.getElementById('rent-longitude').value;
            
            if (!lat || !lng) {
                showAlert("No location to copy. Please get your location first.", "warning");
                return;
            }
            
            const locationText = `${lat}, ${lng}`;
            navigator.clipboard.writeText(locationText).then(
                function() {
                    showAlert("Location coordinates copied to clipboard!", "success");
                },
                function(err) {
                    console.error("Could not copy text:", err);
                    showAlert("Failed to copy location. Please try again.", "error");
                }
            );
        });

        function closeRentModal() {
            rentModal.classList.remove('active');
        }

        function updateRentalTotal() {
            const duration = parseInt(rentDuration.value) || 0;
            const total = (parseFloat(currentProductPrice) * duration).toFixed(4);
            rentTotal.textContent = total;
        }

        // Update the confirmRental function to handle sub-renting
        async function confirmRental() {
            const productId = rentProductId.value;
            const rentLongitude = Math.round(parseFloat(document.getElementById('rent-longitude').value) * 1000000);
            const rentLatitude = Math.round(parseFloat(document.getElementById('rent-latitude').value) * 1000000);
            const duration = parseInt(rentDuration.value);
            
            if (!productId || !duration || duration <= 0) {
                showAlert("Please enter a valid duration", "warning");
                return;
            }
            
            try {
                const product = await getProduct(productId);
                const totalRent = web3.utils.toWei((duration * web3.utils.fromWei(product.priceInWei, 'ether')).toString(), 'ether');
                
                const gasPrice = await web3.eth.getGasPrice();
                let gasEstimate;
                let transaction;

                // Check if this is a sub-rental
                if (!product.available && product.subRentAllowed) {
                    // Use subRentProduct function for sub-rentals
                    gasEstimate = await contract.methods.subRentProduct(
                        productId, 
                        duration * 3600, 
                        rentLatitude, 
                        rentLongitude
                    ).estimateGas({ from: account, value: totalRent });

                    transaction = contract.methods.subRentProduct(
                        productId, 
                        duration * 3600, 
                        rentLatitude, 
                        rentLongitude
                    );
                } else {
                    // Use regular rentProduct function for normal rentals
                    gasEstimate = await contract.methods.rentProduct(
                        productId, 
                        duration * 3600, 
                        rentLatitude, 
                        rentLongitude
                    ).estimateGas({ from: account, value: totalRent });

                    transaction = contract.methods.rentProduct(
                        productId, 
                        duration * 3600, 
                        rentLatitude, 
                        rentLongitude
                    );
                }

                // Execute the transaction
                await transaction.send({ 
                    from: account, 
                    value: totalRent, 
                    gasPrice: gasPrice, 
                    gas: gasEstimate 
                });
                
                showAlert(product.subRentAllowed ? "Product sub-rented successfully!" : "Product rented successfully!", "success");
                closeRentModal();
                await loadProducts();
                await updateBalance();
            } catch (error) {
                console.error("Error renting product:", error);
                showAlert("Transaction failed. Please try again.", "error");
            }
        }

        // Form handlers
        async function handleAddProduct(e) {
            e.preventDefault();
            
            const name = document.getElementById('product-name').value;
            const price = document.getElementById('product-price').value;
            const description = document.getElementById('product-description').value;
            const latitude = document.getElementById('product-latitude').value;
            const longitude = document.getElementById('product-longitude').value;
            const radius = document.getElementById('rental-radius').value;
            const allowSubrenting = document.getElementById('allow-subrenting').checked;
            
            if (!name || !price) {
                showAlert("Please fill in all required fields", "warning");
                return;
            }
            
            if (!latitude || !longitude) {
                showAlert("Please set a location for your product", "warning");
                return;
            }
            
            try {
                const priceInWei = web3.utils.toWei(price.toString(), 'ether');
                
                // Convert latitude and longitude to integers (multiplied by 1e6 to preserve precision)
                const latInt = Math.round(parseFloat(latitude) * 1000000);
                const longInt = Math.round(parseFloat(longitude) * 1000000);
                
                // Add product with sub-renting option
                await contract.methods.addProduct(name, priceInWei, latInt, longInt, radius, allowSubrenting)
                    .send({ from: account });
                
                showAlert("Product added successfully!", "success");
                addProductForm.reset();
                document.getElementById('product-latitude').value = '';
                document.getElementById('product-longitude').value = '';
                document.getElementById('allow-subrenting').checked = false;
                
                // Reset the map
                if (addProductMap) {
                    addProductMap.remove();
                    initAddProductMap();
                }
                
                await loadProducts();
                await loadProductsOnMap();
            } catch (error) {
                console.error("Error adding product:", error);
                showAlert("Failed to add product. Please try again.", "error");
            }
        }

        function handleSaveSettings(e) {
            e.preventDefault();
            
            const name = document.getElementById('user-name').value;
            const email = document.getElementById('user-email').value;
            
            // In a real app, you would save these to a database or local storage
            showAlert("Settings saved successfully!", "success");
        }

        // Utility functions
        function shortenAddress(address) {
            return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
        }

        // Map variables
        let addProductMap = null;
        let addProductMarker = null;
        let productsMap = null;
        let productMarkers = [];
        let radiusCircle = null;
        let detailsMap = null;

        // Initialize maps
        function initMaps() {
            initAddProductMap();
            initProductsMap();
            initRadiusSelector();
        }

        // Initialize the map in the Add Product form
        function initAddProductMap() {
            if (document.getElementById('location-map')) {
                addProductMap = L.map('location-map').setView([0, 0], 2);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(addProductMap);
                
                // Add click event to set location
                addProductMap.on('click', function(e) {
                    setProductLocation(e.latlng.lat, e.latlng.lng);
                });
                
                // Get location button
                document.getElementById('get-location-btn').addEventListener('click', getCurrentLocation);
            }
        }

        // Initialize the products map
        function initProductsMap() {
            if (document.getElementById('products-map')) {
                productsMap = L.map('products-map').setView([0, 0], 2);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(productsMap);

                // Add event listener for the current location button
                document.getElementById('map-location-btn').addEventListener('click', function() {
                    if (navigator.geolocation) {
                        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Locating...';
                        navigator.geolocation.getCurrentPosition(
                            function(position) {
                                const lat = position.coords.latitude;
                                const lng = position.coords.longitude;
                                
                                // Center map on current location with zoom level 13
                                productsMap.setView([lat, lng], 13);
                                
                                // Add or update the user location marker
                                if (window.userLocationMarker) {
                                    window.userLocationMarker.setLatLng([lat, lng]);
                                } else {
                                    window.userLocationMarker = L.marker([lat, lng], {
                                        icon: L.divIcon({
                                            className: 'user-location-marker',
                                            html: '<i class="fas fa-circle" style="color: var(--primary); font-size: 12px;"></i>',
                                            iconSize: [12, 12],
                                            iconAnchor: [6, 6]
                                        })
                                    }).addTo(productsMap);
                                }
                                
                                // Add or update the accuracy circle
                                if (window.accuracyCircle) {
                                    productsMap.removeLayer(window.accuracyCircle);
                                }
                                window.accuracyCircle = L.circle([lat, lng], {
                                    radius: position.coords.accuracy / 2,
                                    color: 'var(--primary)',
                                    fillColor: 'var(--primary)',
                                    fillOpacity: 0.1,
                                    weight: 1
                                }).addTo(productsMap);

                                // Load nearby products
                                loadNearbyProducts(lat, lng);

                                // Reset button text
                                document.getElementById('map-location-btn').innerHTML = '<i class="fas fa-location-crosshairs"></i> Current Location';
                            },
                            function(error) {
                                console.error("Error getting location:", error);
                                showAlert("Unable to retrieve your location. Please check your browser permissions and try again.", "error");
                                // Reset button text
                                document.getElementById('map-location-btn').innerHTML = '<i class="fas fa-location-crosshairs"></i> Current Location';
                            },
                            {
                                enableHighAccuracy: true,
                                timeout: 5000,
                                maximumAge: 0
                            }
                        );
                    } else {
                        showAlert("Geolocation is not supported by this browser.", "error");
                    }
                });
            }
        }

        // Initialize radius selector
        function initRadiusSelector() {
            const radiusInput = document.getElementById('rental-radius');
            const radiusValue = document.getElementById('radius-value');
            const radiusDisplay = radiusValue.parentElement;
            
            if (radiusInput && radiusValue) {
                // Set initial values
                updateSliderGradient(radiusInput);
                updateValuePosition(radiusInput, radiusDisplay);
                
                radiusInput.addEventListener('input', function() {
                    radiusValue.textContent = this.value;
                    updateSliderGradient(this);
                    updateValuePosition(this, radiusDisplay);
                    updateRadiusCircle();
                });
            }
        }

        // Update slider gradient
        function updateSliderGradient(slider) {
            const value = (slider.value - slider.min) / (slider.max - slider.min) * 100;
            slider.style.setProperty('--range-progress', `${value}%`);
        }

        // Update value bubble position
        function updateValuePosition(slider, valueDisplay) {
            const value = (slider.value - slider.min) / (slider.max - slider.min);
            const position = value * 100;
            valueDisplay.style.setProperty('--value-position', `${position}%`);
        }

        // Update radius circle on map
        function updateRadiusCircle() {
            if (!addProductMap || !addProductMarker) return;
            
            const radius = document.getElementById('rental-radius').value;
            
            // Remove existing circle if any
            if (radiusCircle) {
                addProductMap.removeLayer(radiusCircle);
            }
            
            // Add new circle
            radiusCircle = L.circle(addProductMarker.getLatLng(), {
                radius: radius * 1000, // Convert km to meters
                color: 'var(--primary)',
                fillColor: 'var(--primary)',
                fillOpacity: 0.1,
                weight: 2
            }).addTo(addProductMap);
        }

        // Get current location
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        setProductLocation(lat, lng);
                        
                        // Center map on current location
                        if (addProductMap) {
                            addProductMap.setView([lat, lng], 13);
                        }
                    },
                    function(error) {
                        console.error("Error getting location:", error);
                        alert("Unable to retrieve your location. Please try again or set it manually on the map.");
                    }
                );
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        // Set product location
        function setProductLocation(lat, lng) {
            document.getElementById('product-latitude').value = lat.toFixed(6);
            document.getElementById('product-longitude').value = lng.toFixed(6);
            
            // Update or add marker
            if (addProductMarker) {
                addProductMarker.setLatLng([lat, lng]);
            } else {
                addProductMarker = L.marker([lat, lng]).addTo(addProductMap);
            }
            
            // Update radius circle
            updateRadiusCircle();
        }

        // Load products on map
        async function loadProductsOnMap() {
            if (!productsMap || !contract) return;
            
            // Clear existing markers
            productMarkers.forEach(marker => productsMap.removeLayer(marker));
            productMarkers = [];
            
            // Bounds for auto-zooming
            const bounds = L.latLngBounds();
            let hasProducts = false;
            
            try {
                for (let i = 0; i < 20; i++) { // Load up to 20 products
                    const product = await getProduct(i);
                    if (product && product.name) {
                        // Check if product has location data
                        // Assuming the contract returns lat and long as additional properties
                        // If not, you'll need to modify this based on your contract structure
                        if (product.latitude && product.longitude) {
                            // Convert from integer to float (assuming stored as int * 1e6)
                            const lat = parseInt(product.latitude) / 1000000;
                            const lng = parseInt(product.longitude) / 1000000;
                            
                            if (isNaN(lat) || isNaN(lng)) continue;
                            
                            const marker = L.marker([lat, lng]).addTo(productsMap);
                            
                            // Create popup content
                            const priceInEth = web3.utils.fromWei(product.priceInWei, 'ether');
                            const popupContent = `
                                <div class="map-popup">
                                    <div class="map-popup-title">${product.name}</div>
                                    <div class="map-popup-price"><i class="fab fa-ethereum"></i> ${priceInEth} ETH/hour</div>
                                    <div class="map-popup-status ${product.available ? 'available' : 'unavailable'}">
                                        ${product.available ? 'Available' : 'Unavailable'}
                                    </div>
                                    <div class="map-popup-actions">
                                        <button class="btn btn-primary map-rent-btn" data-id="${product.pid}" ${product.available ? '' : 'disabled'}>
                                            Rent
                                        </button>
                                        <button class="btn btn-outline details-btn" data-id="${product.pid}">Details</button>
                                    </div>
                                </div>
                            `;
                            
                            marker.bindPopup(popupContent);
                            marker.on('click', function() {
                                // Add event listener to rent button in popup
                                setTimeout(() => {
                                    const rentBtn = document.querySelector('.map-rent-btn');
                                    if (rentBtn) {
                                        rentBtn.addEventListener('click', function() {
                                            const productId = this.getAttribute('data-id');
                                            openRentModal(productId, product.name, priceInEth);
                                        });
                                    }
                                    const detailsBtn = document.querySelector('.details-btn');
                                    if (detailsBtn) {
                                        detailsBtn.addEventListener('click', function() {
                                            const productId = this.getAttribute('data-id');
                                            openDetailsModal(productId);
                                        });
                                    }
                                }, 100);
                            });
                            
                            productMarkers.push(marker);
                            bounds.extend([lat, lng]);
                            hasProducts = true;
                        }
                    }
                }
                
                // Fit map to bounds if we have products
                if (hasProducts) {
                    productsMap.fitBounds(bounds, { padding: [50, 50] });
                }
            } catch (error) {
                console.error("Error loading products on map:", error);
            }
        }

        // Initialize the app when the window loads
        window.onload = init;

        // Custom Alert System
        function showAlert(message, type = 'info') {
            const alert = document.getElementById('customAlert');
            const overlay = document.getElementById('alertOverlay');
            const messageEl = document.getElementById('alertMessage');
            const iconEl = alert.querySelector('.custom-alert-icon i');
            
            // Set icon and type
            alert.setAttribute('data-type', type);
            switch(type) {
                case 'success':
                    iconEl.className = 'fas fa-check-circle';
                    break;
                case 'error':
                    iconEl.className = 'fas fa-exclamation-circle';
                    break;
                case 'warning':
                    iconEl.className = 'fas fa-exclamation-triangle';
                    break;
                default:
                    iconEl.className = 'fas fa-info-circle';
            }
            
            messageEl.textContent = message;
            overlay.classList.add('show');
            alert.classList.add('show');
            
            // Auto close after 5 seconds
            setTimeout(() => {
                hideAlert();
            }, 5000);
        }
        
        function hideAlert() {
            const alert = document.getElementById('customAlert');
            const overlay = document.getElementById('alertOverlay');
            alert.classList.remove('show');
            overlay.classList.remove('show');
        }
        
        // Close alert when clicking close button or overlay
        document.getElementById('alertClose').addEventListener('click', hideAlert);
        document.getElementById('alertOverlay').addEventListener('click', hideAlert);

        // Details modal functions
        function openDetailsModal(productId) {
            const modal = document.getElementById('details-modal');
            modal.classList.add('active');
            loadProductDetails(productId);
        }

        function closeDetailsModal() {
            const modal = document.getElementById('details-modal');
            modal.classList.remove('active');
            
            // Clean up the map when closing the modal
            if (detailsMap) {
                detailsMap.remove();
                detailsMap = null;
            }
        }

        async function loadProductDetails(productId) {
            try {
                const product = await getProduct(productId);
                if (!product) {
                    showAlert("Error loading product details", "error");
                    return;
                }

                // Update modal fields
                document.getElementById('details-renter-address').value = product.renter || 'No current renter';
                
                // Format start time
                const startTime = product.rentalStartTime > 0 
                    ? new Date(product.rentalStartTime * 1000).toLocaleString()
                    : 'Not currently rented';
                document.getElementById('details-start-time').value = startTime;
                
                // Format duration
                const duration = product.rentalDuration > 0
                    ? `${product.rentalDuration / 3600} hours`
                    : 'Not set';
                document.getElementById('details-duration').value = duration;
                
                // Set radius
                document.getElementById('details-radius').value = `${product.radius} km`;
                
                // Update sub-rental status
                const subrental = document.getElementById('details-subrental-allowed');
                const requester = document.getElementById('details-subrental-requester');
                subrental.className = 'badge ' + (product.subRentAllowed ? 'enabled' : 'disabled');
                subrental.textContent = product.subRentAllowed ? 'Enabled' : 'Disabled';
                
                if (product.subRentRequester && product.subRentRequester !== '0x0000000000000000000000000000000000000000') {
                    requester.textContent = `Requested by: ${shortenAddress(product.subRentRequester)}`;
                } else {
                    requester.textContent = '';
                }
                
                // Set commission rate
                document.getElementById('details-commission').value = `${product.commissionRate}%`;

                // Initialize map
                if (product.latitude && product.longitude) {
                    const lat = parseInt(product.latitude) / 1000000;
                    const lng = parseInt(product.longitude) / 1000000;
                    
                    if (!isNaN(lat) && !isNaN(lng)) {
                        // Remove existing map if it exists
                        if (detailsMap) {
                            detailsMap.remove();
                        }
                        
                        // Create new map
                        detailsMap = L.map('details-map').setView([lat, lng], 13);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '© OpenStreetMap contributors'
                        }).addTo(detailsMap);
                        
                        // Add marker
                        L.marker([lat, lng]).addTo(detailsMap);
                        
                        // Add radius circle
                        L.circle([lat, lng], {
                            radius: product.radius * 1000,
                            color: 'var(--primary)',
                            fillColor: 'var(--primary)',
                            fillOpacity: 0.1,
                            weight: 2
                        }).addTo(detailsMap);

                        // Force a map refresh
                        setTimeout(() => {
                            detailsMap.invalidateSize();
                        }, 100);
                    }
                }
            } catch (error) {
                console.error("Error loading product details:", error);
                showAlert("Failed to load product details", "error");
            }
        }

        // Add event listeners for details modal
        document.getElementById('details-modal-close').addEventListener('click', closeDetailsModal);
        document.getElementById('details-modal-close-btn').addEventListener('click', closeDetailsModal);

        // Update product card event listeners
        function setupProductCardEventListeners() {
            document.querySelectorAll('.details-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const productId = e.target.getAttribute('data-id');
                    openDetailsModal(productId);
                });
            });
        }

        // Function to calculate distance between two points
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the earth in km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const d = R * c; // Distance in km
            return d;
        }

        function deg2rad(deg) {
            return deg * (Math.PI/180);
        }

        // Function to load nearby products
        async function loadNearbyProducts(userLat, userLng) {
            if (!contract) return;
            
            // Clear existing markers
            productMarkers.forEach(marker => productsMap.removeLayer(marker));
            productMarkers = [];
            
            try {
                for (let i = 0; i < 20; i++) { // Load up to 20 products
                    const product = await getProduct(i);
                    if (product && product.name && product.available) {
                        // Check if product has location data
                        if (product.latitude && product.longitude) {
                            const lat = parseInt(product.latitude) / 1000000;
                            const lng = parseInt(product.longitude) / 1000000;
                            
                            if (isNaN(lat) || isNaN(lng)) continue;
                            
                            // Calculate distance from user
                            const distance = calculateDistance(userLat, userLng, lat, lng);
                            
                            // Only show products within 50km radius
                            if (distance <= 50) {
                                const marker = L.marker([lat, lng]).addTo(productsMap);
                                
                                // Create popup content
                                const priceInEth = web3.utils.fromWei(product.priceInWei, 'ether');
                                const popupContent = `
                                    <div class="map-popup">
                                        <div class="map-popup-title">${product.name}</div>
                                        <div class="map-popup-price"><i class="fab fa-ethereum"></i> ${priceInEth} ETH/hour</div>
                                        <div class="map-popup-distance">${distance.toFixed(1)} km away</div>
                                        <div class="map-popup-actions">
                                            <button class="btn btn-primary map-rent-btn" data-id="${product.pid}" data-name="${product.name}" data-price="${priceInEth}">
                                                Rent Now
                                            </button>
                                            <button class="btn btn-outline details-btn" data-id="${product.pid}">Details</button>
                                        </div>
                                    </div>
                                `;
                                
                                marker.bindPopup(popupContent);
                                
                                // Add click event to rent button in popup
                                marker.on('click', function() {
                                    setTimeout(() => {
                                        const rentBtn = document.querySelector('.map-rent-btn');
                                        if (rentBtn) {
                                            rentBtn.addEventListener('click', function() {
                                                const productId = this.getAttribute('data-id');
                                                const productName = this.getAttribute('data-name');
                                                const productPrice = this.getAttribute('data-price');
                                                openRentModal(productId, productName, productPrice);
                                            });
                                        }
                                        const detailsBtn = document.querySelector('.details-btn');
                                        if (detailsBtn) {
                                            detailsBtn.addEventListener('click', function() {
                                                const productId = this.getAttribute('data-id');
                                                openDetailsModal(productId);
                                            });
                                        }
                                    }, 100);
                                });
                                
                                productMarkers.push(marker);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error("Error loading nearby products:", error);
                showAlert("Failed to load nearby products", "error");
            }
        }

        // Update the Orders page content loading
        async function loadOrders(filterType = 'all') {
            const ordersTableBody = document.getElementById('orders-table-body');
            ordersTableBody.innerHTML = '';
            
            if (!contract || !account) {
                showAlert("Please connect your wallet first", "warning");
                return;
            }
            
            try {
                const ownedProducts = [];
                const rentedProducts = [];
                
                // Iterate through products
                for (let i = 0; i < 20; i++) {
                    const product = await getProduct(i);
                    if (product && product.name) {
                        if (product.owner.toLowerCase() === account.toLowerCase()) {
                            ownedProducts.push({ ...product, pid: i });
                        } else if (product.renter && product.renter.toLowerCase() === account.toLowerCase()) {
                            rentedProducts.push({ ...product, pid: i });
                        }
                    }
                }
                
                // Filter products based on selected filter
                let productsToShow = [];
                switch (filterType) {
                    case 'owned':
                        productsToShow = ownedProducts;
                        break;
                    case 'rented':
                        productsToShow = rentedProducts;
                        break;
                    case 'active':
                        const currentTime = Math.floor(Date.now() / 1000);
                        productsToShow = [...ownedProducts, ...rentedProducts].filter(product => {
                            const rentalEndTime = parseInt(product.rentalStartTime) + parseInt(product.rentalDuration);
                            return !product.available && currentTime < rentalEndTime;
                        });
                        break;
                    case 'available':
                        productsToShow = ownedProducts.filter(product => product.available);
                        break;
                    default: // 'all'
                        productsToShow = [...ownedProducts, ...rentedProducts];
                }
                
                // Display filtered products
                if (productsToShow.length === 0) {
                    ordersTableBody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center;">No products found for selected filter</td>
                        </tr>
                    `;
                    return;
                }
                
                // Sort products by rental start time (most recent first)
                productsToShow.sort((a, b) => b.rentalStartTime - a.rentalStartTime);
                
                for (const product of productsToShow) {
                    const row = document.createElement('tr');
                    const status = getProductStatus(product);
                    const isRented = product.renter.toLowerCase() === account.toLowerCase();
                    
                    // Add return button for rented products that are active
                    const isActiveRental = !product.available && 
                        product.renter.toLowerCase() === account.toLowerCase() && 
                        (parseInt(product.rentalStartTime) + parseInt(product.rentalDuration)) > Math.floor(Date.now() / 1000);
                    
                    row.innerHTML = `
                        <td>#${product.pid}</td>
                        <td>${product.name}${isRented ? ' (Rented)' : ''}</td>
                        <td>${formatTimestamp(product.rentalStartTime)}</td>
                        <td>${web3.utils.fromWei(product.priceInWei, 'ether')} ETH/hr</td>
                        <td><span class="status-badge ${status.class}"><i class="${status.icon}"></i> ${status.text}</span></td>
                        <td>
                            <div class="action-buttons">
                            <button class="btn btn-outline btn-sm details-btn" data-id="${product.pid}">View</button>
                                ${isActiveRental ? `
                                    <button class="btn btn-primary btn-sm return-btn" data-id="${product.pid}">
                                        <i class="fas fa-undo"></i> Return
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    `;
                    ordersTableBody.appendChild(row);
                }
                
                // Setup button listeners
                setupOrderButtonListeners();
                
            } catch (error) {
                console.error("Error loading orders:", error);
                showAlert("Failed to load orders", "error");
            }
        }

        // Helper function to determine product status
        function getProductStatus(product) {
            if (!product.available && product.renter !== '0x0000000000000000000000000000000000000000') {
                const currentTime = Math.floor(Date.now() / 1000);
                const rentalEndTime = parseInt(product.rentalStartTime) + parseInt(product.rentalDuration);
                
                if (currentTime < rentalEndTime) {
                    return {
                        class: 'approved',
                        icon: 'fas fa-clock',
                        text: 'Active Rental'
                    };
                } else {
                    return {
                        class: 'returned',
                        icon: 'fas fa-check',
                        text: 'Completed'
                    };
                }
            } else if (product.available) {
                return {
                    class: 'pending',
                    icon: 'fas fa-circle',
                    text: 'Available'
                };
            } else {
                return {
                    class: 'cancelled',
                    icon: 'fas fa-times',
                    text: 'Unavailable'
                };
            }
        }

        // Helper function to format timestamp
        function formatTimestamp(timestamp) {
            if (!timestamp || timestamp === '0') {
                return 'N/A';
            }
            return new Date(timestamp * 1000).toLocaleString();
        }

        // Add this JavaScript function to handle filtering
        function setupOrderFilters() {
            const filterOptions = document.querySelectorAll('#orders-page .filter-options .filter-option');
            
            filterOptions.forEach(option => {
                option.addEventListener('click', async function() {
                    // Update active state
                    filterOptions.forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Get filter type
                    const filterType = this.getAttribute('data-filter');
                    
                    // Reload orders with filter
                    await loadOrders(filterType);
                });
            });
        }

        async function loadDashboardStats() {
            if (!contract || !account) return;
            
            try {
                let totalProducts = 0;
                let activeRentals = 0;
                let pendingOrders = 0;
                let totalRevenue = web3.utils.toBN('0');
                const currentTime = Math.floor(Date.now() / 1000);

                // Get all products
                for (let i = 0; i < 10; i++) {
                    try {
                        const product = await getProduct(i);
                        if (product && product.name) {
                            // Count total products
                            totalProducts++;
                            
                            // Check if product is rented and rental is active
                            if (product.renter !== '0x0000000000000000000000000000000000000000') {
                                const rentalEndTime = parseInt(product.rentalStartTime) + parseInt(product.rentalDuration);
                                if (currentTime < rentalEndTime) {
                                    activeRentals++;
                                }
                                
                                // Calculate revenue
                                const rentalPrice = web3.utils.toBN(product.priceInWei);
                                const duration = web3.utils.toBN(product.rentalDuration).div(web3.utils.toBN('3600')); // Convert seconds to hours
                                const productRevenue = rentalPrice.mul(duration);
                                totalRevenue = totalRevenue.add(productRevenue);
                            }
                            
                            // Count available products as pending orders
                            if (product.available) {
                                pendingOrders++;
                            }
                        }
                    } catch (error) {
                        console.error(`Error fetching product ${i}:`, error);
                        continue;
                    }
                }

                // Convert total revenue from Wei to ETH and format to 4 decimal places
                const revenueInEth = web3.utils.fromWei(totalRevenue, 'ether');
                const formattedRevenue = parseFloat(revenueInEth).toFixed(4);

                // Update dashboard stats
                document.querySelector('.stats-grid .stat-card:nth-child(1) .stat-value').textContent = totalProducts;
                document.querySelector('.stats-grid .stat-card:nth-child(2) .stat-value').textContent = activeRentals;
                document.querySelector('.stats-grid .stat-card:nth-child(3) .stat-value').textContent = pendingOrders;
                document.querySelector('.stats-grid .stat-card:nth-child(4) .stat-value').textContent = `${formattedRevenue} ETH`;

                // Update change indicators
                updateChangeIndicator(1, totalProducts > 0);
                updateChangeIndicator(2, activeRentals > 0);
                updateChangeIndicator(3, pendingOrders > 0);
                updateChangeIndicator(4, !totalRevenue.isZero());

            } catch (error) {
                console.error("Error loading dashboard stats:", error);
                showAlert("Failed to load dashboard statistics", "error");
            }
        }

        // Add this helper function for updating change indicators
        function updateChangeIndicator(cardIndex, isPositive) {
            const card = document.querySelector(`.stats-grid .stat-card:nth-child(${cardIndex}) .stat-change`);
            if (card) {
                card.className = `stat-change ${isPositive ? 'positive' : 'negative'}`;
                card.innerHTML = `
                    <i class="fas fa-arrow-${isPositive ? 'up' : 'down'}"></i>
                    <span>${isPositive ? 'Active' : 'Inactive'}</span>
                `;
            }
        }

        // Add this new function to handle return product
        async function handleReturnProductClick() {
            // Show the return modal
            const returnModal = document.getElementById('return-modal');
            returnModal.classList.add('active');

                // Get current location
            if (navigator.geolocation) {
                try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    });
                });

                    document.getElementById('return-latitude').value = position.coords.latitude.toFixed(6);
                    document.getElementById('return-longitude').value = position.coords.longitude.toFixed(6);
            } catch (error) {
                    console.error("Error getting location:", error);
                    showAlert("Unable to get location. Please try again.", "error");
                }
            }
        }

        // Add this function to handle the return confirmation
        async function handleReturnConfirm() {
            try {
                const productId = document.getElementById('return-product-id').value;
                if (!productId) {
                    showAlert("Please enter a product ID", "warning");
                    return;
                }

                const latitude = Math.round(parseFloat(document.getElementById('return-latitude').value) * 1000000);
                const longitude = Math.round(parseFloat(document.getElementById('return-longitude').value) * 1000000);

                // Show loading state
                const button = document.getElementById('return-modal-confirm');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                button.disabled = true;

                // Estimate gas
                const gasEstimate = await contract.methods.returnProduct(productId, latitude, longitude)
                    .estimateGas({ from: account });

                // Execute return
                await contract.methods.returnProduct(productId, latitude, longitude)
                    .send({ from: account, gas: gasEstimate });

                showAlert("Product returned successfully!", "success");
                closeReturnModal();
                await loadOrders();
                await loadDashboardStats();

            } catch (error) {
                console.error("Error returning product:", error);
                showAlert("Failed to return product. Please try again.", "error");
            } finally {
                const button = document.getElementById('return-modal-confirm');
                button.innerHTML = '<i class="fas fa-undo"></i> Confirm Return';
                button.disabled = false;
            }
        }

        // Add this function to close the return modal
        function closeReturnModal() {
            const modal = document.getElementById('return-modal');
            modal.classList.remove('active');
            document.getElementById('return-product-id').value = '';
        }

        // Add this function to setup button listeners
        function setupOrderButtonListeners() {
            // Setup details button listeners
            document.querySelectorAll('.details-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const productId = e.target.getAttribute('data-id');
                    openDetailsModal(productId);
                });
            });

            // Setup return button listeners
            document.querySelectorAll('.return-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const productId = e.target.getAttribute('data-id');
                    if (confirm('Are you sure you want to return this product?')) {
                        await handleReturnProduct(productId);
                    }
                });
            });
        }

        // Add some CSS for the action buttons
        const style = document.createElement('style');
        style.textContent = `
            .action-buttons {
                display: flex;
                gap: 0.5rem;
                justify-content: flex-end;
            }
            
            .return-btn {
                background-color: var(--primary);
                color: white;
            }
            
            .return-btn:hover {
                background-color: var(--primary-dark);
            }

            .dashboard-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 2rem;
            }

            .header-actions {
                display: flex;
                align-items: center;
                gap: 1rem;
            }

            .return-product-btn {
                padding: 0.5rem 1rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                background-color: var(--primary);
                color: white;
                border: none;
                border-radius: 0.5rem;
                cursor: pointer;
                transition: background-color 0.2s;
            }

            .return-product-btn:hover {
                background-color: var(--primary-dark);
            }

            .return-product-btn i {
                font-size: 1rem;
            }
        `;
        document.head.appendChild(style);

        // Add these styles to your existing style element
        const certificationStyles = `
            .certificates-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 1.5rem;
                padding: 1.5rem 0;
                perspective: 1000px;
            }

            .certificate-card {
                background: var(--card);
                border: 1px solid var(--border);
                border-radius: var(--radius);
                overflow: hidden;
                transition: all 0.3s ease;
                transform-style: preserve-3d;
                position: relative;
            }

            .certificate-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 0 20px rgba(124, 58, 237, 0.2),
                            0 0 40px rgba(124, 58, 237, 0.1);
                border-color: var(--primary);
            }

            .certificate-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                border-radius: var(--radius);
                border: 2px solid transparent;
                transition: all 0.3s ease;
                pointer-events: none;
            }

            .certificate-card:hover::before {
                border-color: var(--primary);
                box-shadow: 0 0 15px var(--primary);
            }

            .certificate-image-container {
                position: relative;
                height: 180px;
                background: rgba(255, 255, 255, 0.05);
                overflow: hidden;
            }

            .certificate-image {
                width: 100%;
                height: 100%;
                object-fit: cover;
                transition: transform 0.3s ease;
            }

            .certificate-card:hover .certificate-image {
                transform: scale(1.05);
            }

            .certificate-badge {
                position: absolute;
                top: 1rem;
                right: 1rem;
                padding: 0.4rem 0.8rem;
                border-radius: 9999px;
                background: rgba(124, 58, 237, 0.2);
                color: var(--primary);
                font-size: 0.75rem;
                font-weight: 600;
                backdrop-filter: blur(4px);
                border: 1px solid rgba(124, 58, 237, 0.3);
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .certificate-content {
                padding: 1.5rem;
            }

            .certificate-content h3 {
                font-size: 1.25rem;
                font-weight: 600;
                margin-bottom: 0.5rem;
                color: var(--text-primary);
            }

            .manufacturer {
                font-size: 0.875rem;
                color: var(--text-secondary);
                margin-bottom: 1rem;
            }

            .type-badge {
                display: inline-block;
                padding: 0.3rem 0.8rem;
                border-radius: var(--radius);
                background: rgba(124, 58, 237, 0.1);
                color: var(--primary);
                font-size: 0.75rem;
                font-weight: 500;
                border: 1px solid rgba(124, 58, 237, 0.2);
            }

            .certificate-expiry {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                margin-top: 1rem;
                font-size: 0.875rem;
                color: var(--text-secondary);
            }

            .certificate-footer {
                display: flex;
                justify-content: space-between;
                padding: 1.25rem;
                border-top: 1px solid var(--border);
                background: rgba(0, 0, 0, 0.2);
            }

            .certificate-button {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.5rem 1rem;
                border-radius: var(--radius);
                background: transparent;
                border: 1px solid var(--border);
                color: var(--text-primary);
                font-size: 0.875rem;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .certificate-button:hover {
                background: var(--primary);
                border-color: var(--primary);
                color: white;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(124, 58, 237, 0.2);
            }

            /* Search and Filter Styles */
            .cert-controls {
                display: flex;
                gap: 1rem;
                margin-bottom: 2rem;
            }

            .search-input-container {
                position: relative;
                flex: 1;
                max-width: 400px;
            }

            .search-input {
                width: 100%;
                padding: 0.75rem 1rem 0.75rem 2.5rem;
                border-radius: var(--radius);
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid var(--border);
                color: var(--text-primary);
                font-size: 0.875rem;
                transition: all 0.3s ease;
            }

            .search-input:focus {
                border-color: var(--primary);
                box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.2);
                outline: none;
            }

            .search-icon {
                position: absolute;
                left: 0.75rem;
                top: 50%;
                transform: translateY(-50%);
                color: var(--text-secondary);
            }

            .select-input {
                padding: 0.75rem 2.5rem 0.75rem 1rem;
                border-radius: var(--radius);
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid var(--border);
                color: var(--text-primary);
                font-size: 0.875rem;
                cursor: pointer;
                transition: all 0.3s ease;
                appearance: none;
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 0.5rem center;
                background-size: 1rem;
            }

            .select-input:focus {
                border-color: var(--primary);
                box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.2);
                outline: none;
            }
        `;

        document.head.appendChild(document.createElement('style')).textContent = certificationStyles;

        // Add these functions to your existing JavaScript
        async function loadCertifications() {
            const container = document.getElementById('certificates-container');
            const searchTerm = document.getElementById('cert-search').value.toLowerCase();
            const typeFilter = document.getElementById('cert-type-filter').value;
            
            try {
                // In a real implementation, you would fetch this data from your smart contract
                const certificates = await getCertificatesData();
                
                // Filter certificates based on search and type
                const filteredCerts = certificates.filter(cert => {
                    const matchesSearch = cert.name.toLowerCase().includes(searchTerm) ||
                                        cert.manufacturer.toLowerCase().includes(searchTerm);
                    const matchesType = typeFilter === 'all' || cert.type.toLowerCase() === typeFilter.toLowerCase();
                    return matchesSearch && matchesType;
                });
                
                // Clear container and add filtered certificates
                    container.innerHTML = '';
                    filteredCerts.forEach(cert => {
                        container.appendChild(createCertificateCard(cert));
                    });
            } catch (error) {
                console.error('Error loading certificates:', error);
                showAlert('Failed to load certificates', 'error');
            }
        }

        // Add this to your JavaScript
        const MOCK_CERTIFICATES = [
            {
                id: '1',
                name: 'MRI Scanner Model X500',
                manufacturer: 'MedTech Imaging',
                type: 'Imaging Equipment',
                status: 'Valid',
                expiryDate: '05/14/2025',
                image: 'https://images.unsplash.com/photo-1516549655169-df83a0774514?w=500'
            },
            {
                id: '2',
                name: 'Patient Monitor PM-8000',
                manufacturer: 'HealthCare Systems',
                type: 'Monitoring Devices',
                status: 'Valid',
                expiryDate: '06/21/2025',
                image: 'https://images.unsplash.com/photo-1530026405186-ed1f139313f8?w=500'
            },
            {
                id: '3',
                name: 'Surgical Robot SR-X',
                manufacturer: 'Precision Surgical',
                type: 'Surgical Tools',
                status: 'Valid',
                expiryDate: '04/09/2025',
                image: 'https://images.unsplash.com/photo-1582719471384-894fbb16e074?w=500'
            },
            {
                id: '4',
                name: 'Digital X-Ray System DX-100',
                manufacturer: 'RadiTech',
                type: 'Imaging Equipment',
                status: 'Valid',
                expiryDate: '07/04/2025',
                image: 'https://images.unsplash.com/photo-1584362917165-526a968579e8?w=500'
            },
            {
                id: '5',
                name: 'Ultrasound Scanner US-Pro',
                manufacturer: 'SonoMed',
                type: 'Diagnostic Equipment',
                status: 'Valid',
                expiryDate: '11/17/2024',
                image: 'https://images.unsplash.com/photo-1579684385127-1ef15d508118?w=500'
            },
            {
                id: '6',
                name: 'ECG Machine ECG-12L',
                manufacturer: 'CardioTech',
                type: 'Diagnostic Equipment',
                status: 'Valid',
                expiryDate: '09/29/2024',
                image: 'https://images.unsplash.com/photo-1581595220892-b0739db3ba8c?w=500'
            }
        ];

        // Update the getCertificatesData function
        async function getCertificatesData() {
            return MOCK_CERTIFICATES;
        }

        // Add tilt effect to certificates
        function addTiltEffect(card) {
            card.addEventListener('mousemove', (e) => {
                const rect = card.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                
                const rotateX = (y - centerY) / 20;
                const rotateY = (centerX - x) / 20;
                
                card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) translateY(-5px)`;
            });
            
            card.addEventListener('mouseleave', () => {
                card.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) translateY(0)';
            });
        }

        // Update the createCertificateCard function
        function createCertificateCard(cert) {
            const card = document.createElement('div');
            card.className = 'certificate-card';
            card.innerHTML = `
                <div class="certificate-image-container">
                    <img src="${cert.image}" alt="${cert.name}" class="certificate-image">
                    <div class="certificate-badge">${cert.status}</div>
                </div>
                <div class="certificate-content">
                    <h3>${cert.name}</h3>
                    <p class="manufacturer">
                        <i class="fas fa-building"></i> ${cert.manufacturer}
                    </p>
                    <div class="certificate-type">
                        <span class="type-badge">
                            <i class="fas fa-tag"></i> ${cert.type}
                        </span>
                    </div>
                    <div class="certificate-expiry">
                        <i class="fas fa-clock"></i>
                        <span>Expires: ${cert.expiryDate}</span>
                    </div>
                </div>
                <div class="certificate-footer">
                    <button class="certificate-button" onclick="viewCertificate('${cert.id}')">
                        <i class="fas fa-eye"></i>
                        View
                    </button>
                    <button class="certificate-button" onclick="downloadCertificate('${cert.id}')">
                        <i class="fas fa-download"></i>
                        Download
                    </button>
                </div>
            `;
            
            addTiltEffect(card);
            return card;
        }

        // Add event listeners for search and filter
        document.getElementById('cert-search').addEventListener('input', debounce(loadCertifications, 300));
        document.getElementById('cert-type-filter').addEventListener('change', loadCertifications);

        // Helper function for debouncing
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Placeholder functions for view and download
        function viewCertificate(id) {
            // Implement certificate viewing logic
            showAlert('Viewing certificate ' + id, 'info');
        }

        function downloadCertificate(id) {
            // Implement certificate download logic
            showAlert('Downloading certificate ' + id, 'info');
        }
    </script>
</body>
</html>

