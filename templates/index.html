{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medichain - Rental DApp</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.5/web3.min.js"></script>
    <script src='https://cdn.jotfor.ms/s/umd/latest/for-embedded-agent.js'></script>
    <style>
        :root {
            --primary: #00E5FF;
            --primary-dark: #00B8D4;
            --secondary: #7B68EE;
            --accent: #FF5722;
            --dark: #0A0E17;
            --darker: #060A12;
            --light: #ffffff;
            --gray: #8A8F98;
            --gray-light: #F0F2F5;
            --success: #4CAF50;
            --warning: #FFC107;
            --danger: #F44336;
            --info: #2196F3;
            --sidebar-width: 280px;
            --header-height: 70px;
            --border-radius: 12px;
            --card-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark);
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: rgba(6, 10, 18, 0.95);
            backdrop-filter: blur(10px);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            transition: var(--transition);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .logo {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--light);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo span {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .sidebar-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--gray);
            font-size: 1.25rem;
            cursor: pointer;
        }

        .sidebar-content {
            padding: 1.5rem 0;
            flex: 1;
            overflow-y: auto;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu-item {
            margin-bottom: 0.5rem;
        }

        .sidebar-menu-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: var(--gray);
            text-decoration: none;
            transition: var(--transition);
            border-left: 3px solid transparent;
            gap: 0.75rem;
        }

        .sidebar-menu-link:hover, .sidebar-menu-link.active {
            background: rgba(255, 255, 255, 0.05);
            color: var(--light);
            border-left-color: var(--primary);
        }

        .sidebar-menu-link i {
            width: 20px;
            text-align: center;
        }

        .sidebar-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--dark);
            font-weight: 600;
        }

        .user-details {
            flex: 1;
            overflow: hidden;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-role {
            font-size: 0.75rem;
            color: var(--gray);
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            transition: var(--transition);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            height: var(--header-height);
            background: rgba(6, 10, 18, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .page-title {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
            font-size: 1.25rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .balance-display {
            background: rgba(255, 255, 255, 0.05);
            padding: 0.5rem 1rem;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .balance-display i {
            color: var(--primary);
        }

        .btn {
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: var(--dark);
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--light);
        }

        .btn-outline:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .content {
            flex: 1;
            padding: 2rem;
            background: radial-gradient(circle at 50% 0%, rgba(123, 104, 238, 0.05), transparent 70%);
        }

        /* Dashboard Styles */
        .dashboard {
            display: grid;
            gap: 2rem;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .dashboard-title {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
            font-size: 1.75rem;
            background: linear-gradient(90deg, var(--light), var(--primary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .dashboard-actions {
            display: flex;
            gap: 1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-title {
            font-size: 0.875rem;
            color: var(--gray);
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .stat-icon.blue {
            background: rgba(33, 150, 243, 0.1);
            color: var(--info);
        }

        .stat-icon.green {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success);
        }

        .stat-icon.orange {
            background: rgba(255, 152, 0, 0.1);
            color: var(--warning);
        }

        .stat-icon.red {
            background: rgba(244, 67, 54, 0.1);
            color: var(--danger);
        }

        .stat-value {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.75rem;
            font-weight: 700;
        }

        .stat-change {
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .stat-change.positive {
            color: var(--success);
        }

        .stat-change.negative {
            color: var(--danger);
        }

        /* Product Grid Styles */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .filter-options {
            display: flex;
            gap: 0.75rem;
        }

        .filter-option {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 50px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .filter-option:hover, .filter-option.active {
            background: rgba(255, 255, 255, 0.1);
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .product-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--border-radius);
            overflow: hidden;
            transition: var(--transition);
            border: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .product-image {
            height: 180px;
            width: 100%;
            object-fit: cover;
            background: linear-gradient(135deg, rgba(0, 229, 255, 0.1), rgba(123, 104, 238, 0.1));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 3rem;
        }

        .product-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .product-badge.available {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success);
        }

        .product-badge.unavailable {
            background: rgba(244, 67, 54, 0.2);
            color: var(--danger);
        }

        .product-content {
            padding: 1.25rem;
        }

        .product-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 1.125rem;
        }

        .product-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .product-info-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
        }

        .product-info-label {
            color: var(--gray);
        }

        .product-info-value {
            font-weight: 500;
        }

        .product-price {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .product-actions {
            display: flex;
            gap: 0.75rem;
        }

        .product-actions .btn {
            flex: 1;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--darker);
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transform: translateY(20px);
            transition: var(--transition);
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
            font-size: 1.25rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--gray);
            font-size: 1.25rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .modal-close:hover {
            color: var(--light);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--light);
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.1);
        }

        .form-control::placeholder {
            color: var(--gray);
        }

        .form-text {
            font-size: 0.75rem;
            color: var(--gray);
            margin-top: 0.5rem;
        }

        /* Toggle Switch Styles */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.25rem;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
        }

        .info-icon {
            color: var(--gray);
            font-size: 1rem;
            cursor: help;
            position: relative;
            display: inline-flex;
            align-items: center;
        }

        .info-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--darker);
            color: var(--light);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: normal;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            pointer-events: none;
            width: max-content;
            max-width: 250px;
            z-index: 100;
        }

        .info-icon:hover .info-tooltip {
            opacity: 1;
            visibility: visible;
            bottom: calc(100% + 10px);
        }

        .info-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid var(--darker);
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .location-inputs {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .location-coordinates {
            display: flex;
            gap: 0.5rem;
            flex: 1;
        }

        .location-coordinates .form-control {
            flex: 1;
        }

        .radius-selector {
            display: flex;
            align-items: center;
            gap: 1rem;
            position: relative;
            padding: 1.5rem 0;
        }

        .radius-selector input[type="range"] {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            background: linear-gradient(to right, var(--primary) var(--range-progress), rgba(255, 255, 255, 0.1) var(--range-progress));
            border-radius: 2px;
            outline: none;
        }

        .radius-selector input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 2;
        }

        .radius-value-display {
            position: absolute;
            background: #fff;
            color: var(--dark);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 1rem;
            transform: translateX(-50%);
            bottom: calc(100% - 1rem);
            left: var(--value-position);
            min-width: 60px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: left 0.1s ease;
        }

        .radius-value-display::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid #fff;
        }

        .radius-selector input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
        }

        .radius-selector input[type="range"]:active::-webkit-slider-thumb {
            transform: scale(1.2);
        }

        .map-popup {
            font-family: 'Inter', sans-serif;
        }

        .map-popup-title {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .map-popup-price {
            color: var(--primary);
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .map-popup-status {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .map-popup-status.available {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success);
        }

        .map-popup-status.unavailable {
            background: rgba(244, 67, 54, 0.2);
            color: var(--danger);
        }

        .map-popup-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .map-popup-actions .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            background: var(--darker);
            color: var(--light);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .leaflet-popup-tip {
            background: var(--darker);
        }

        .leaflet-container a.leaflet-popup-close-button {
            color: var(--gray);
        }

        .leaflet-container a.leaflet-popup-close-button:hover {
            color: var(--light);
        }

        /* Order Status Styles */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-badge.pending {
            background: rgba(255, 193, 7, 0.2);
            color: var(--warning);
        }

        .status-badge.approved {
            background: rgba(33, 150, 243, 0.2);
            color: var(--info);
        }

        .status-badge.shipped {
            background: rgba(156, 39, 176, 0.2);
            color: #9C27B0;
        }

        .status-badge.returned {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success);
        }

        .status-badge.cancelled {
            background: rgba(244, 67, 54, 0.2);
            color: var(--danger);
        }

        /* Orders Table */
        .orders-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .orders-table th,
        .orders-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .orders-table th {
            font-weight: 600;
            color: var(--gray);
            font-size: 0.875rem;
        }

        .orders-table tbody tr {
            transition: var(--transition);
        }

        .orders-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .orders-table td {
            font-size: 0.875rem;
        }

        /* Responsive Styles */
        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .sidebar-toggle {
                display: block;
            }
            
            .header {
                padding: 0 1rem;
            }
            
            .content {
                padding: 1.5rem;
            }
            
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .dashboard-actions {
                width: 100%;
            }
            
            .dashboard-actions .btn {
                flex: 1;
            }
            
            .filter-options {
                overflow-x: auto;
                padding-bottom: 0.5rem;
                width: 100%;
            }
            
            .filter-option {
                white-space: nowrap;
            }
        }

        @media (max-width: 576px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .product-grid {
                grid-template-columns: 1fr;
            }
            
            .header-actions {
                gap: 0.5rem;
            }
            
            .balance-display {
                display: none;
            }
            
            .orders-table {
                display: block;
                overflow-x: auto;
            }
        }

        /* Animation Keyframes */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .text-primary {
            color: var(--primary);
        }

        .text-success {
            color: var(--success);
        }

        .text-warning {
            color: var(--warning);
        }

        .text-danger {
            color: var(--danger);
        }

        .text-info {
            color: var(--info);
        }

        /* Map Location Button Styles */
        .map-container {
            position: relative;
            margin-bottom: 2rem;
        }

        .map-location-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--darker);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.75rem 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            color: var(--light);
        }

        .map-location-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }

        .map-location-btn i {
            margin-right: 0.5rem;
            color: var(--primary);
        }

        .user-location-marker {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-location-marker i {
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-link" style="color: var(--primary);"></i>
                    <span>Medichain</span>
                </div>
                <button class="sidebar-toggle" id="sidebar-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="sidebar-content">
                <ul class="sidebar-menu">
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link active" data-page="dashboard">
                            <i class="fas fa-th-large"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link" data-page="products">
                            <i class="fas fa-box"></i>
                            <span>Products</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link" data-page="add-product">
                            <i class="fas fa-plus-circle"></i>
                            <span>Add Product</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link" data-page="orders">
                            <i class="fas fa-clipboard-list"></i>
                            <span>Orders</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link" data-page="map-view">
                            <i class="fas fa-map-marked-alt"></i>
                            <span>Map View</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link" data-page="settings">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                </ul>
            </div>
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-details">
                        <div class="user-name" id="user-address">Not Connected</div>
                        <div class="user-role">Wallet not connected</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <button class="sidebar-toggle" id="sidebar-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title" id="page-title">Dashboard</h1>
                <div class="header-actions">
                    <div class="balance-display">
                        <i class="fab fa-ethereum"></i>
                        <span id="eth-balance">0</span> ETH
                    </div>
                    <button class="btn btn-primary" id="connect-wallet">
                        <i class="fas fa-wallet"></i>
                        Connect Wallet
                    </button>
                </div>
            </header>

            <div class="content">
                <!-- Dashboard Page -->
                <div class="page" id="dashboard-page">
                    <div class="dashboard">
                        <div class="dashboard-header">
                            <h2 class="dashboard-title">Dashboard Overview</h2>
                            <div class="dashboard-actions">
                                <button class="btn btn-primary" id="rent-now-btn">
                                    <i class="fas fa-shopping-cart"></i>
                                    Rent Now
                                </button>
                                <button class="btn btn-outline" id="add-product-btn">
                                    <i class="fas fa-plus"></i>
                                    Add Product
                                </button>
                            </div>
                        </div>

                        <script>
                          window.addEventListener("DOMContentLoaded", function() {
                            window.AgentInitializer.init({
                              agentRenderURL: "https://agent.jotform.com/0195acef6ba2785686ac249d516aa5d4b50e",
                              rootId: "JotformAgent-0195acef6ba2785686ac249d516aa5d4b50e",
                              formID: "0195acef6ba2785686ac249d516aa5d4b50e",
                              queryParams: ["skipWelcome=1", "maximizable=1"],
                              domain: "https://www.jotform.com",
                              isDraggable: false,
                              background: "linear-gradient(180deg, #D3CBF4 0%, #D3CBF4 100%)",
                              buttonBackgroundColor: "#8797FF",
                              buttonIconColor: "#FFFFFF",
                              variant: false,
                              customizations: {
                                "greeting": "Yes",
                                "greetingMessage": "Hi! How can I assist you?",
                                "openByDefault": "No",
                                "pulse": "Yes",
                                "position": "right",
                                "autoOpenChatIn": "0"
                              },
                              isVoice: undefined
                            });
                          });
                        </script>

                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-title">Total Products</div>
                                    <div class="stat-icon blue">
                                        <i class="fas fa-box"></i>
                                    </div>
                                </div>
                                <div class="stat-value">24</div>
                                <div class="stat-change positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>12% from last month</span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-title">Active Rentals</div>
                                    <div class="stat-icon green">
                                        <i class="fas fa-handshake"></i>
                                    </div>
                                </div>
                                <div class="stat-value">8</div>
                                <div class="stat-change positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>5% from last month</span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-title">Pending Orders</div>
                                    <div class="stat-icon orange">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                </div>
                                <div class="stat-value">3</div>
                                <div class="stat-change negative">
                                    <i class="fas fa-arrow-down"></i>
                                    <span>2% from last month</span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-title">Total Revenue</div>
                                    <div class="stat-icon blue">
                                        <i class="fab fa-ethereum"></i>
                                    </div>
                                </div>
                                <div class="stat-value">5.24 ETH</div>
                                <div class="stat-change positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>18% from last month</span>
                                </div>
                            </div>
                        </div>

                        <div class="section-header">
                            <h3 class="section-title">Featured Products</h3>
                            <div class="filter-options">
                                <div class="filter-option active">All</div>
                                <div class="filter-option">Available</div>
                                <div class="filter-option">Medical</div>
                                <div class="filter-option">Equipment</div>
                            </div>
                        </div>

                        <div class="product-grid" id="product-container">
                            <!-- Products will be loaded here dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Products Page -->
                <div class="page hidden" id="products-page">
                    <div class="section-header">
                        <h2 class="dashboard-title">All Products</h2>
                        <div class="filter-options">
                            <div class="filter-option active">All</div>
                            <div class="filter-option">Available</div>
                            <div class="filter-option">Unavailable</div>
                        </div>
                    </div>
                    <div class="product-grid" id="all-products-container">
                        <!-- All products will be loaded here -->
                    </div>
                </div>

                <!-- Add Product Page -->
                <div class="page hidden" id="add-product-page">
                    <div class="dashboard-header">
                        <h2 class="dashboard-title">Add New Product</h2>
                    </div>
                    <div class="form-container">
                        <form id="add-product-form">
                            <div class="form-group">
                                <label class="form-label" for="product-name">Product Name</label>
                                <input type="text" class="form-control" id="product-name" placeholder="Enter product name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="product-price">Price (ETH)</label>
                                <input type="number" class="form-control" id="product-price" placeholder="0.01" step="0.001" min="0" required>
                                <div class="form-text">Price per hour in ETH</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="product-description">Description</label>
                                <textarea class="form-control" id="product-description" rows="4" placeholder="Enter product description"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Location</label>
                                <div class="location-inputs">
                                    <div class="location-coordinates">
                                        <input type="text" class="form-control" id="product-latitude" placeholder="Latitude" readonly>
                                        <input type="text" class="form-control" id="product-longitude" placeholder="Longitude" readonly>
                                    </div>
                                    <button type="button" class="btn btn-outline" id="get-location-btn">
                                        <i class="fas fa-map-marker-alt"></i>
                                        Get Current Location
                                    </button>
                                </div>
                                <div class="form-text">Click the button to automatically fetch your current location</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="rental-radius">Rental Radius (km)</label>
                                <div class="radius-selector">
                                    <input type="range" class="form-control" id="rental-radius" min="1" max="50" value="5" step="1">
                                    <div class="radius-value-display">
                                        <span id="radius-value">5</span> km
                                    </div>
                                </div>
                                <div class="form-text">Select the radius within which you want to rent your product</div>
                            </div>
                            <div class="form-group">
                                <div class="toggle-container">
                                    <label class="toggle-label">
                                        Allow Sub-renting
                                        <div class="info-icon">
                                            <i class="fas fa-info-circle"></i>
                                            <div class="info-tooltip">
                                                Sub-renting allows the renter to rent this product to other users while they have it rented, creating a rental chain. You'll still earn your original rental fee.
                                            </div>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="allow-subrenting">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <div id="location-map" style="height: 300px; border-radius: 12px;"></div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus-circle"></i>
                                Add Product
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Orders Page -->
                <div class="page hidden" id="orders-page">
                    <div class="dashboard-header">
                        <h2 class="dashboard-title">Order Status</h2>
                        <div class="filter-options">
                            <div class="filter-option active">All</div>
                            <div class="filter-option">Pending</div>
                            <div class="filter-option">Approved</div>
                            <div class="filter-option">Shipped</div>
                            <div class="filter-option">Returned</div>
                        </div>
                    </div>
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Product</th>
                                <th>Date</th>
                                <th>Price</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body">
                            <tr>
                                <td>#ORD-001</td>
                                <td>Oxygen Concentrator</td>
                                <td>2023-05-15</td>
                                <td>0.25 ETH</td>
                                <td><span class="status-badge pending"><i class="fas fa-clock"></i> Pending</span></td>
                                <td>
                                    <button class="btn btn-outline btn-sm">View</button>
                                </td>
                            </tr>
                            <tr>
                                <td>#ORD-002</td>
                                <td>Hospital Bed</td>
                                <td>2023-05-12</td>
                                <td>0.5 ETH</td>
                                <td><span class="status-badge approved"><i class="fas fa-check"></i> Approved</span></td>
                                <td>
                                    <button class="btn btn-outline btn-sm">View</button>
                                </td>
                            </tr>
                            <tr>
                                <td>#ORD-003</td>
                                <td>Wheelchair</td>
                                <td>2023-05-10</td>
                                <td>0.15 ETH</td>
                                <td><span class="status-badge shipped"><i class="fas fa-truck"></i> Shipped</span></td>
                                <td>
                                    <button class="btn btn-outline btn-sm">View</button>
                                </td>
                            </tr>
                            <tr>
                                <td>#ORD-004</td>
                                <td>Blood Pressure Monitor</td>
                                <td>2023-05-05</td>
                                <td>0.08 ETH</td>
                                <td><span class="status-badge returned"><i class="fas fa-undo"></i> Returned</span></td>
                                <td>
                                    <button class="btn btn-outline btn-sm">View</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Settings Page -->
                <div class="page hidden" id="settings-page">
                    <div class="dashboard-header">
                        <h2 class="dashboard-title">Settings</h2>
                    </div>
                    <div class="form-container">
                        <form id="settings-form">
                            <div class="form-group">
                                <label class="form-label" for="user-name">Display Name</label>
                                <input type="text" class="form-control" id="user-name" placeholder="Enter your name">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="user-email">Email</label>
                                <input type="email" class="form-control" id="user-email" placeholder="Enter your email">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Connected Wallet</label>
                                <div class="form-control" id="connected-wallet-display">Not connected</div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i>
                                Save Settings
                            </button>
                        </form>
                    </div>
                </div>
                <!-- Map View Page -->
                <div class="page hidden" id="map-view-page">
                    <div class="dashboard-header">
                        <h2 class="dashboard-title">Product Map</h2>
                        <div class="filter-options">
                            <div class="filter-option active">All Products</div>
                            <div class="filter-option">Available Only</div>
                            <div class="filter-option">My Products</div>
                        </div>
                    </div>
                    <div class="map-container" style="position: relative;">
                        <div id="products-map" style="height: 600px; border-radius: 12px;"></div>
                        <button class="btn btn-primary map-location-btn" id="map-location-btn">
                            <i class="fas fa-location-crosshairs"></i>
                            Current Location
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Rent Product Modal -->
    <div class="modal-overlay" id="rent-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Rent Product</h3>
                <button class="modal-close" id="rent-modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="rent-product-id">Product ID</label>
                    <input type="text" class="form-control" id="rent-product-id" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label" for="rent-product-name">Product Name</label>
                    <input type="text" class="form-control" id="rent-product-name" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label" for="rent-duration">Rental Duration (hours)</label>
                    <input type="number" class="form-control" id="rent-duration" min="1" value="24">
                    <div class="form-text">Minimum rental period is 1 hour</div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="rent-total">Total Cost</label>
                    <div class="product-price" id="rent-total">
                        <i class="fab fa-ethereum"></i>
                        <span>0.00</span> ETH
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="rent-modal-cancel">Cancel</button>
                <button class="btn btn-primary" id="rent-modal-confirm">Confirm Rental</button>
            </div>
        </div>
    </div>

    <script>
        let web3;
        let contract;
        let account;
        const contractAddress = "0x87cd65f6d1faC2b428B8F928b8FF7Cc7293CEA78";
        let currentPage = "dashboard";

        // DOM Elements
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebarClose = document.getElementById('sidebar-close');
        const connectWalletBtn = document.getElementById('connect-wallet');
        const rentNowBtn = document.getElementById('rent-now-btn');
        const addProductBtn = document.getElementById('add-product-btn');
        const pageTitle = document.getElementById('page-title');
        const userAddress = document.getElementById('user-address');
        const connectedWalletDisplay = document.getElementById('connected-wallet-display');
        
        // Modal Elements
        const rentModal = document.getElementById('rent-modal');
        const rentModalClose = document.getElementById('rent-modal-close');
        const rentModalCancel = document.getElementById('rent-modal-cancel');
        const rentModalConfirm = document.getElementById('rent-modal-confirm');
        const rentProductId = document.getElementById('rent-product-id');
        const rentProductName = document.getElementById('rent-product-name');
        const rentDuration = document.getElementById('rent-duration');
        const rentTotal = document.getElementById('rent-total').querySelector('span');
        
        // Forms
        const addProductForm = document.getElementById('add-product-form');
        const settingsForm = document.getElementById('settings-form');

        // Initialize the application
        async function init() {
            setupEventListeners();
            await checkWalletConnection();
            initMaps();
            
            // Initialize chatbot
            window.addEventListener("DOMContentLoaded", function() {
                window.AgentInitializer.init({
                    agentRenderURL: "https://agent.jotform.com/0195acef6ba2785686ac249d516aa5d4b50e",
                    rootId: "JotformAgent-0195acef6ba2785686ac249d516aa5d4b50e",
                    formID: "0195acef6ba2785686ac249d516aa5d4b50e",
                    queryParams: ["skipWelcome=1", "maximizable=1"],
                    domain: "https://www.jotform.com",
                    isDraggable: false,
                    background: "linear-gradient(180deg, #D3CBF4 0%, #D3CBF4 100%)",
                    buttonBackgroundColor: "#8797FF",
                    buttonIconColor: "#FFFFFF",
                    variant: false,
                    customizations: {
                        "greeting": "Yes",
                        "greetingMessage": "Hi! How can I assist you?",
                        "openByDefault": "No",
                        "pulse": "Yes",
                        "position": "right",
                        "autoOpenChatIn": "0"
                    },
                    isVoice:true
                });
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Sidebar toggle
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.add('active');
            });
            
            sidebarClose.addEventListener('click', () => {
                sidebar.classList.remove('active');
            });
            
            // Navigation
            document.querySelectorAll('.sidebar-menu-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetPage = link.getAttribute('data-page');
                    navigateToPage(targetPage);
                    
                    // On mobile, close the sidebar after navigation
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('active');
                    }
                });
            });
            
            // Connect wallet button
            connectWalletBtn.addEventListener('click', connectWallet);
            
            // Quick action buttons
            rentNowBtn.addEventListener('click', () => navigateToPage('products'));
            addProductBtn.addEventListener('click', () => navigateToPage('add-product'));
            
            // Modal events
            rentModalClose.addEventListener('click', closeRentModal);
            rentModalCancel.addEventListener('click', closeRentModal);
            rentModalConfirm.addEventListener('click', confirmRental);
            
            // Form submissions
            addProductForm.addEventListener('submit', handleAddProduct);
            settingsForm.addEventListener('submit', handleSaveSettings);
            
            // Rent duration change
            rentDuration.addEventListener('input', updateRentalTotal);
        }

        // Page navigation
        function navigateToPage(pageName) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
            });
            
            // Show the selected page
            document.getElementById(`${pageName}-page`).classList.remove('hidden');
            
            // Update active link in sidebar
            document.querySelectorAll('.sidebar-menu-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-page') === pageName) {
                    link.classList.add('active');
                }
            });
            
            // Update page title
            pageTitle.textContent = pageName.charAt(0).toUpperCase() + pageName.slice(1).replace('-', ' ');
            
            // Update current page
            currentPage = pageName;
            
            // Show/hide chatbot based on current page
            const chatbotContainer = document.getElementById('JotformAgent-0195acef6ba2785686ac249d516aa5d4b50e');
            if (chatbotContainer) {
                chatbotContainer.style.display = pageName === 'dashboard' ? 'block' : 'none';
            }
            
            // Special handling for map pages
            if (pageName === 'map-view') {
                // Need to refresh the map when it becomes visible
                setTimeout(() => {
                    if (productsMap) {
                        productsMap.invalidateSize();
                        loadProductsOnMap();
                    }
                }, 100);
            } else if (pageName === 'add-product') {
                // Refresh the add product map
                setTimeout(() => {
                    if (addProductMap) {
                        addProductMap.invalidateSize();
                    }
                }, 100);
            }
        }

        // Wallet connection
        async function checkWalletConnection() {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                try {
                    const accounts = await web3.eth.getAccounts();
                    if (accounts.length > 0) {
                        account = accounts[0];
                        updateUIForConnectedWallet();
                        await loadContract();
                        await updateBalance();
                        await loadProducts();
                    } else {
                        updateUIForDisconnectedWallet();
                    }
                } catch (error) {
                    console.error("Error checking wallet connection", error);
                    updateUIForDisconnectedWallet();
                }
            } else {
                console.log("Ethereum provider not found");
                updateUIForDisconnectedWallet();
            }
        }

        async function connectWallet() {
            if (window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    account = accounts[0];
                    updateUIForConnectedWallet();
                    await loadContract();
                    await updateBalance();
                    await loadProducts();
                } catch (error) {
                    console.error("Error connecting wallet", error);
                    alert("Failed to connect wallet. Please try again.");
                }
            } else {
                alert("Please install MetaMask to use this application.");
            }
        }

        function updateUIForConnectedWallet() {
            connectWalletBtn.innerHTML = `<i class="fas fa-wallet"></i> ${shortenAddress(account)}`;
            userAddress.textContent = shortenAddress(account);
            document.querySelector('.user-role').textContent = "Connected";
            connectedWalletDisplay.textContent = account;
        }

        function updateUIForDisconnectedWallet() {
            connectWalletBtn.innerHTML = `<i class="fas fa-wallet"></i> Connect Wallet`;
            userAddress.textContent = "Not Connected";
            document.querySelector('.user-role').textContent = "Wallet not connected";
            connectedWalletDisplay.textContent = "Not connected";
        }

        // Contract interaction
        async function loadContract() {
            try {
                const response = await fetch("{% static 'ABI.json' %}");
                const contractABI = await response.json();
                contract = new web3.eth.Contract(contractABI, contractAddress);
            } catch (error) {
                console.error("Error loading contract:", error);
                alert("Failed to load contract. Please refresh the page.");
            }
        }

        async function updateBalance() {
            try {
                const balance = await web3.eth.getBalance(account);
                document.getElementById("eth-balance").textContent = parseFloat(web3.utils.fromWei(balance, 'ether')).toFixed(4);
            } catch (error) {
                console.error("Error updating balance:", error);
            }
        }

        async function getProduct(productId) {
            try {
                const product = await contract.methods.products(productId).call();
        
            // If your contract doesn't return lat/long directly, you might need to call a separate method
            // This is a placeholder - adjust based on your actual contract structure
            try {
                const locationData = await contract.methods.getProductLocation(productId).call();
                product.latitude = locationData.latitude;
                product.longitude = locationData.longitude;
            } catch (e) {
                // If location method doesn't exist or fails, set defaults
                product.latitude = 0;
                product.longitude = 0;
            }
        
            return product;
        } catch (error) {
            console.error(`Error fetching product ${productId}:`, error);
            return null;
        }
    }

        async function loadProducts() {
            const productContainer = document.getElementById("product-container");
            const allProductsContainer = document.getElementById("all-products-container");
            
            if (!contract) return;
            
            productContainer.innerHTML = "";
            allProductsContainer.innerHTML = "";
            
            try {
                for (let i = 0; i < 10; i++) { // Load up to 10 products
                    const product = await getProduct(i);
                    if (product && product.name) {
                        // Create product card
                        const productCard = createProductCard(product);
                        
                        // Add to dashboard featured products
                        productContainer.appendChild(productCard.cloneNode(true));
                        
                        // Add to all products page
                        allProductsContainer.appendChild(productCard);
                    }
                }
                
                // Add event listeners to rent buttons
                document.querySelectorAll('.rent-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const productId = e.target.getAttribute('data-id');
                        const productName = e.target.getAttribute('data-name');
                        const productPrice = e.target.getAttribute('data-price');
                        openRentModal(productId, productName, productPrice);
                    });
                });
                
                // Also load products on the map
                await loadProductsOnMap();
            } catch (error) {
                console.error("Error loading products:", error);
            }
        }

        function createProductCard(product) {
            const productCard = document.createElement("div");
            productCard.className = "product-card";
            
            const priceInEth = web3.utils.fromWei(product.priceInWei, 'ether');
            
            productCard.innerHTML = `
                <div class="product-badge ${product.available ? 'available' : 'unavailable'}">
                    ${product.available ? 'Available' : 'Unavailable'}
                </div>
                <div class="product-image">
                    <i class="fas fa-heartbeat"></i>
                </div>
                <div class="product-content">
                    <h3 class="product-title">${product.name}</h3>
                    <div class="product-info">
                        <div class="product-info-item">
                            <span class="product-info-label">Product ID:</span>
                            <span class="product-info-value">#${product.pid}</span>
                        </div>
                        <div class="product-info-item">
                            <span class="product-info-label">Owner:</span>
                            <span class="product-info-value">${shortenAddress(product.owner)}</span>
                        </div>
                    </div>
                    <div class="product-price">
                        <i class="fab fa-ethereum"></i>
                        <span>${priceInEth}</span> ETH/hour
                    </div>
                    <div class="product-actions">
                        <button class="btn btn-primary rent-btn" data-id="${product.pid}" data-name="${product.name}" data-price="${priceInEth}" ${product.available ? '' : 'disabled'}>
                            <i class="fas fa-shopping-cart"></i>
                            Rent Now
                        </button>
                        <button class="btn btn-outline">
                            <i class="fas fa-info-circle"></i>
                            Details
                        </button>
                    </div>
                </div>
            `;
            
            return productCard;
        }

        // Rental modal functions
        function openRentModal(productId, productName, productPrice) {
            rentProductId.value = productId;
            rentProductName.value = productName;
            currentProductPrice = productPrice;
            updateRentalTotal();
            rentModal.classList.add('active');
        }

        function closeRentModal() {
            rentModal.classList.remove('active');
        }

        function updateRentalTotal() {
            const duration = parseInt(rentDuration.value) || 0;
            const total = (parseFloat(currentProductPrice) * duration).toFixed(4);
            rentTotal.textContent = total;
        }

        async function confirmRental() {
            const productId = rentProductId.value;
            const duration = parseInt(rentDuration.value);
            
            if (!productId || !duration || duration <= 0) {
                alert("Please enter a valid duration");
                return;
            }
            
            try {
                const product = await getProduct(productId);
                const totalRent = web3.utils.toWei((duration * web3.utils.fromWei(product.priceInWei, 'ether')).toString(), 'ether');
                
                await contract.methods.rentProduct(productId, duration * 3600, 0, 0)
                    .send({ from: account, value: totalRent });
                
                alert("Product rented successfully!");
                closeRentModal();
                await loadProducts();
                await updateBalance();
            } catch (error) {
                console.error("Error renting product:", error);
                alert("Transaction failed. Please try again.");
            }
        }

        // Form handlers
        async function handleAddProduct(e) {
            e.preventDefault();
            
            const name = document.getElementById('product-name').value;
            const price = document.getElementById('product-price').value;
            const description = document.getElementById('product-description').value;
            const latitude = document.getElementById('product-latitude').value;
            const longitude = document.getElementById('product-longitude').value;
            const radius = document.getElementById('rental-radius').value;
            const allowSubrenting = document.getElementById('allow-subrenting').checked;
            
            if (!name || !price) {
                alert("Please fill in all required fields");
                return;
            }
            
            if (!latitude || !longitude) {
                alert("Please set a location for your product");
                return;
            }
            
            try {
                const priceInWei = web3.utils.toWei(price.toString(), 'ether');
                
                // Convert latitude and longitude to integers (multiplied by 1e6 to preserve precision)
                const latInt = Math.round(parseFloat(latitude) * 1000000);
                const longInt = Math.round(parseFloat(longitude) * 1000000);
                
                // Add product with sub-renting option
                await contract.methods.addProduct(name, priceInWei, latInt, longInt, radius, allowSubrenting)
                    .send({ from: account });
                
                alert("Product added successfully!");
                addProductForm.reset();
                document.getElementById('product-latitude').value = '';
                document.getElementById('product-longitude').value = '';
                document.getElementById('allow-subrenting').checked = false;
                
                // Reset the map
                if (addProductMap) {
                    addProductMap.remove();
                    initAddProductMap();
                }
                
                await loadProducts();
                await loadProductsOnMap();
            } catch (error) {
                console.error("Error adding product:", error);
                alert("Failed to add product. Please try again.");
            }
        }

        function handleSaveSettings(e) {
            e.preventDefault();
            
            const name = document.getElementById('user-name').value;
            const email = document.getElementById('user-email').value;
            
            // In a real app, you would save these to a database or local storage
            alert("Settings saved successfully!");
        }

        // Utility functions
        function shortenAddress(address) {
            return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
        }

        // Map variables
        let addProductMap = null;
        let addProductMarker = null;
        let productsMap = null;
        let productMarkers = [];
        let radiusCircle = null;

        // Initialize maps
        function initMaps() {
            initAddProductMap();
            initProductsMap();
            initRadiusSelector();
        }

        // Initialize the map in the Add Product form
        function initAddProductMap() {
            if (document.getElementById('location-map')) {
                addProductMap = L.map('location-map').setView([0, 0], 2);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(addProductMap);
                
                // Add click event to set location
                addProductMap.on('click', function(e) {
                    setProductLocation(e.latlng.lat, e.latlng.lng);
                });
                
                // Get location button
                document.getElementById('get-location-btn').addEventListener('click', getCurrentLocation);
            }
        }

        // Initialize the products map
        function initProductsMap() {
            if (document.getElementById('products-map')) {
                productsMap = L.map('products-map').setView([0, 0], 2);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(productsMap);

                // Add event listener for the current location button
                document.getElementById('map-location-btn').addEventListener('click', function() {
                    if (navigator.geolocation) {
                        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Locating...';
                        navigator.geolocation.getCurrentPosition(
                            function(position) {
                                const lat = position.coords.latitude;
                                const lng = position.coords.longitude;
                                
                                // Center map on current location with zoom level 13
                                productsMap.setView([lat, lng], 13);
                                
                                // Add or update the user location marker
                                if (window.userLocationMarker) {
                                    window.userLocationMarker.setLatLng([lat, lng]);
                                } else {
                                    window.userLocationMarker = L.marker([lat, lng], {
                                        icon: L.divIcon({
                                            className: 'user-location-marker',
                                            html: '<i class="fas fa-circle" style="color: var(--primary); font-size: 12px;"></i>',
                                            iconSize: [12, 12],
                                            iconAnchor: [6, 6]
                                        })
                                    }).addTo(productsMap);
                                }
                                
                                // Add or update the accuracy circle
                                if (window.accuracyCircle) {
                                    productsMap.removeLayer(window.accuracyCircle);
                                }
                                window.accuracyCircle = L.circle([lat, lng], {
                                    radius: position.coords.accuracy / 2,
                                    color: 'var(--primary)',
                                    fillColor: 'var(--primary)',
                                    fillOpacity: 0.1,
                                    weight: 1
                                }).addTo(productsMap);

                                // Reset button text
                                document.getElementById('map-location-btn').innerHTML = '<i class="fas fa-location-crosshairs"></i> Current Location';
                            },
                            function(error) {
                                console.error("Error getting location:", error);
                                alert("Unable to retrieve your location. Please check your browser permissions and try again.");
                                // Reset button text
                                document.getElementById('map-location-btn').innerHTML = '<i class="fas fa-location-crosshairs"></i> Current Location';
                            },
                            {
                                enableHighAccuracy: true,
                                timeout: 5000,
                                maximumAge: 0
                            }
                        );
                    } else {
                        alert("Geolocation is not supported by this browser.");
                    }
                });
            }
        }

        // Initialize radius selector
        function initRadiusSelector() {
            const radiusInput = document.getElementById('rental-radius');
            const radiusValue = document.getElementById('radius-value');
            const radiusDisplay = radiusValue.parentElement;
            
            if (radiusInput && radiusValue) {
                // Set initial values
                updateSliderGradient(radiusInput);
                updateValuePosition(radiusInput, radiusDisplay);
                
                radiusInput.addEventListener('input', function() {
                    radiusValue.textContent = this.value;
                    updateSliderGradient(this);
                    updateValuePosition(this, radiusDisplay);
                    updateRadiusCircle();
                });
            }
        }

        // Update slider gradient
        function updateSliderGradient(slider) {
            const value = (slider.value - slider.min) / (slider.max - slider.min) * 100;
            slider.style.setProperty('--range-progress', `${value}%`);
        }

        // Update value bubble position
        function updateValuePosition(slider, valueDisplay) {
            const value = (slider.value - slider.min) / (slider.max - slider.min);
            const position = value * 100;
            valueDisplay.style.setProperty('--value-position', `${position}%`);
        }

        // Update radius circle on map
        function updateRadiusCircle() {
            if (!addProductMap || !addProductMarker) return;
            
            const radius = document.getElementById('rental-radius').value;
            
            // Remove existing circle if any
            if (radiusCircle) {
                addProductMap.removeLayer(radiusCircle);
            }
            
            // Add new circle
            radiusCircle = L.circle(addProductMarker.getLatLng(), {
                radius: radius * 1000, // Convert km to meters
                color: 'var(--primary)',
                fillColor: 'var(--primary)',
                fillOpacity: 0.1,
                weight: 2
            }).addTo(addProductMap);
        }

        // Get current location
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        setProductLocation(lat, lng);
                        
                        // Center map on current location
                        if (addProductMap) {
                            addProductMap.setView([lat, lng], 13);
                        }
                    },
                    function(error) {
                        console.error("Error getting location:", error);
                        alert("Unable to retrieve your location. Please try again or set it manually on the map.");
                    }
                );
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        // Set product location
        function setProductLocation(lat, lng) {
            document.getElementById('product-latitude').value = lat.toFixed(6);
            document.getElementById('product-longitude').value = lng.toFixed(6);
            
            // Update or add marker
            if (addProductMarker) {
                addProductMarker.setLatLng([lat, lng]);
            } else {
                addProductMarker = L.marker([lat, lng]).addTo(addProductMap);
            }
            
            // Update radius circle
            updateRadiusCircle();
        }

        // Load products on map
        async function loadProductsOnMap() {
            if (!productsMap || !contract) return;
            
            // Clear existing markers
            productMarkers.forEach(marker => productsMap.removeLayer(marker));
            productMarkers = [];
            
            // Bounds for auto-zooming
            const bounds = L.latLngBounds();
            let hasProducts = false;
            
            try {
                for (let i = 0; i < 20; i++) { // Load up to 20 products
                    const product = await getProduct(i);
                    if (product && product.name) {
                        // Check if product has location data
                        // Assuming the contract returns lat and long as additional properties
                        // If not, you'll need to modify this based on your contract structure
                        if (product.latitude && product.longitude) {
                            // Convert from integer to float (assuming stored as int * 1e6)
                            const lat = parseInt(product.latitude) / 1000000;
                            const lng = parseInt(product.longitude) / 1000000;
                            
                            if (isNaN(lat) || isNaN(lng)) continue;
                            
                            const marker = L.marker([lat, lng]).addTo(productsMap);
                            
                            // Create popup content
                            const priceInEth = web3.utils.fromWei(product.priceInWei, 'ether');
                            const popupContent = `
                                <div class="map-popup">
                                    <div class="map-popup-title">${product.name}</div>
                                    <div class="map-popup-price"><i class="fab fa-ethereum"></i> ${priceInEth} ETH/hour</div>
                                    <div class="map-popup-status ${product.available ? 'available' : 'unavailable'}">
                                        ${product.available ? 'Available' : 'Unavailable'}
                                    </div>
                                    <div class="map-popup-actions">
                                        <button class="btn btn-primary map-rent-btn" data-id="${product.pid}" ${product.available ? '' : 'disabled'}>
                                            Rent
                                        </button>
                                        <button class="btn btn-outline">Details</button>
                                    </div>
                                </div>
                            `;
                            
                            marker.bindPopup(popupContent);
                            marker.on('click', function() {
                                // Add event listener to rent button in popup
                                setTimeout(() => {
                                    const rentBtn = document.querySelector('.map-rent-btn');
                                    if (rentBtn) {
                                        rentBtn.addEventListener('click', function() {
                                            const productId = this.getAttribute('data-id');
                                            openRentModal(productId, product.name, priceInEth);
                                        });
                                    }
                                }, 100);
                            });
                            
                            productMarkers.push(marker);
                            bounds.extend([lat, lng]);
                            hasProducts = true;
                        }
                    }
                }
                
                // Fit map to bounds if we have products
                if (hasProducts) {
                    productsMap.fitBounds(bounds, { padding: [50, 50] });
                }
            } catch (error) {
                console.error("Error loading products on map:", error);
            }
        }

        // Initialize the app when the window loads
        window.onload = init;
    </script>
</body>
</html>

